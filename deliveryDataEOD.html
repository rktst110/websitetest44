
<!-- Importing Firebase SDK Starts Here-->
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
 <!-- Importing Firebase SDK Ends Here-->
 
 <!-- Importing JS files for charts of CanvaJs & HighCharts Starts Here-->
<script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/heatmap.js"></script>
<script src="https://code.highcharts.com/modules/treemap.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
 <!-- Importing JS files for charts of CanvaJs & HighCharts Ends Here-->
 

  <script src="functions/commonFunctions.js"></script>
  <script src="functions/tableSortingFunctons.js"></script>
 <script src="functions/importFiles.js"></script>
 <script src="functions/firebase.js"></script>
 <script src="functions/firebaseFunctions.js"></script>
 <script src="functions/indexedDBFunctions.js"></script>

 <div id="importedContent"></div>
 
 <title>Delivery Data</title>
 
 

<style>

thead {
  position: sticky;
  top: 0;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background-color: #555;
  color: white; /* Set the text color to white */
}

* {
  box-sizing: border-box;
}

/* Create two unequal columns that floats next to each other */
.column {
  float: left;
  padding: 0.5px;
  height: 520px; /* Should be removed. Only for demonstration */
}

.equityLeft {
  width: 50%;
}

.spurtsRight {
  width: 50%;
}

.left {
  width: 25%;
}

.right {
  width: 75%;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

@media screen and (max-width: 800px) {
  .column {
    width: 100%;
  }
}
</style>

<style> .toggle {cursor: pointer;display: inline-block;}.toggle-switch {display: inline-block;background: #ccc;border-radius: 16px;width: 58px;height: 32px;position: relative;vertical-align: middle;transition: background 0.25s;}.toggle-switch:before, .toggle-switch:after {content: "";}.toggle-switch:before {display: block;background: linear-gradient(to bottom, #fff 0%, #eee 100%);border-radius: 50%;box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.25);width: 24px;height: 24px;position: absolute;top: 4px;left: 4px;transition: left 0.25s;}.toggle:hover .toggle-switch:before {background: linear-gradient(to bottom, #fff 0%, #fff 100%);box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.5);}.toggle-checkbox:checked + .toggle-switch {background: #56c080;}.toggle-checkbox:checked + .toggle-switch:before {left: 30px;}.toggle-checkbox {position: absolute;visibility: hidden;}.toggle-label {margin-left: 5px;position: relative;top: 2px;} </style>
	

<style> .toggle {cursor: pointer;display: inline-block;}.toggle-switch {display: inline-block;background: #ccc;border-radius: 16px;width: 58px;height: 32px;position: relative;vertical-align: middle;transition: background 0.25s;}.toggle-switch:before, .toggle-switch:after {content: "";}.toggle-switch:before {display: block;background: linear-gradient(to bottom, #fff 0%, #eee 100%);border-radius: 50%;box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.25);width: 24px;height: 24px;position: absolute;top: 4px;left: 4px;transition: left 0.25s;}.toggle:hover .toggle-switch:before {background: linear-gradient(to bottom, #fff 0%, #fff 100%);box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.5);}.toggle-checkbox:checked + .toggle-switch {background: #56c080;}.toggle-checkbox:checked + .toggle-switch:before {left: 30px;}.toggle-checkbox {position: absolute;visibility: hidden;}.toggle-label {margin-left: 5px;position: relative;top: 2px;} </style>
		
 <label>Month Year:</label>
<select id="monthYear" onchange="getFirestoreData()">
</select>

 <label> | Trading Date:</label>
<select id="tradingDate" onchange="setCommonSelectors()">
</select>


 <label> | Common TimeValues:</label>
<select id="commonTimeValues" onchange="saveSelectedValues();fetchDataForAllSegments()">
</select>

&nbsp; | &nbsp;&nbsp;
<button id="dataRefreshButton" onclick="getFirestoreData('refresh','')">Refresh</button>
&nbsp;&nbsp;<button id="dataRefreshButton" onclick="getFirestoreData('live','')">Live</button>



&nbsp; | &nbsp;&nbsp;
<span class="toggle-label">Current Delivery:  </span> <label class="toggle">  <input id="useCurrentDateDelivery" class="toggle-checkbox" type="checkbox"> <div class="toggle-switch"></div> </label> 

<hr>

 <label> Indices TimeValues:</label>
<select id="indicesTimeValues" onchange="getIndicesData()">
</select>

&nbsp; | &nbsp;&nbsp;
 <label> Spurts TimeValues:</label>
<select id="spurtsTimeValues" onchange="getSpurtsEquityData()">
</select>

&nbsp; | &nbsp;&nbsp;
 <label> Delivery Dates:</label>
<select id="spurtsTimeValues" onchange="getSpurtsEquityData()">
</select>

<!--Content Start From Here-->
<br>
<br>

<div class="row">
	<center>
	<button onclick="document.getElementById('tableListSelector').value='FnO';getDeliveryData()">FnO</button>
	<button onclick="document.getElementById('tableListSelector').value='NIFTY_50';getDeliveryData()">Nifty 50</button>
   <button onclick="document.getElementById('tableListSelector').value='NIFTY_BANK';getDeliveryData()">Banks</button>
   <button onclick="document.getElementById('tableListSelector').value='NIFTY_FIN_SERVICE';getDeliveryData()">Finance</button>
   <button onclick="document.getElementById('tableListSelector').value='NIFTY_MIDCAP_150';getDeliveryData()">Midcap</button>
    | List:	<select id="tableListSelector" aria-labelledby="expiryLbl" onchange="getDeliveryData()"> </select> 
	| Avg Days: 		 <input id="avgDays" type="number" value="10"  size="3">
	<br> Symbols:	<select id="deliveryStockSymbol" onchange="showPerticularStocksDeliveryDataInTable()"></select>
	| Prev Trading Days: 		 <input id="previousTradingDays" type="number" value="10"  size="3">
	</center><br>
  <div class="column equityLeft" style="background-color:#aaa;">
    <div class="spaceBetweenTables">  	<div id="perticularStockDeliveryTableContainer"></div> </div>
  </div>
  <div class="column spurtsRight" style="background-color:#bbb;">
    <div class="spaceBetweenTables">  	<div id="deliveryDataTableContainer"></div> </div>
  </div>
</div>


<!--Content Ends Here-->


<script>
function fetchDataForAllSegments()
{
//setIndicesSelectorTimeValues( "syncWithCommonTime" );
setDeliverySelectorTimeValues( "syncWithCommonTime" );
}
</script>


<!-- Indices Code Starts Here -->
<script>

function setIndicesSelectorTimeValues( passedValue )
{
	var tradingDate = document.getElementById('tradingDate').value
	var timeValuesArray = firestoreIndexObj[ tradingDate ]['Index']['index_performace']
	var selectElementRef = document.getElementById("indicesTimeValues");
	
	handleTimeValues( passedValue, timeValuesArray, selectElementRef, getIndicesData )
}

async function getIndicesData( passedValue )
{
	var selectedMonthYear = document.getElementById('monthYear').value
	var selectedTradingDate = document.getElementById('tradingDate').value
	var selectedTimeValue = document.getElementById('indicesTimeValues').value
	
	var docPath = '/'+selectedMonthYear+'/'+selectedTradingDate+'/index_performace/'+selectedTimeValue
	//var docPath = '/'+selectedMonthYear+'/'+selectedTradingDate+'/pre_open_market/FnO/'+selectedTimeValue+'/'+selectedTimeValue
	
	//await fetchFirebaseDocData( docPath, showIndicesPerformanceChart )
	var dataObj = await fetchFirebaseDocData( docPath )
	showIndicesPerformanceChart ( JSON.parse( dataObj['data'] ) )

}

async function showIndicesPerformanceChart ( returnedDataObj )
{
	var selectedIndicesTimeValues = document.getElementById('indicesTimeValues').value
	//var selectedValue = document.getElementById("indices_performance_time").value;
		
	//var indicesPerformanceObject = mainOIDataObject['index_performace'][selectedValue]
	var indicesPerformanceObject = returnedDataObj ['data']
		
	var dataPointsArray=[]
	var dataPointsArrayAdvances=[]
	var dataPointsArrayDeclines=[]
	var dataPointsArrayUnchanged=[]
	var dataPointsArrayPChangeAddition=[]
	
	var tempObj={}
	for (var symbol in indicesPerformanceObject) {
		//if(symbol !='INDIA VIX' && symbol !='NIFTY PSU BANK' && symbol !='NIFTY PVT BANK' && symbol !='NIFTY FINSRV25 50' && symbol !='NIFTY HEALTHCARE' )
		if(symbol !='INDIA VIX' && symbol !='NIFTY FINSRV25 50' && symbol !='NIFTY HEALTHCARE' )
			
		{
		tempObj[symbol]=indicesPerformanceObject[symbol]['percentChange']
		}
	}
	
// tempObj is sorted by this code
//Object.keys(tempObj).sort((a,b) => tempObj[a]-tempObj[b]).forEach((symbol) => { 	// ascending sort
Object.keys(tempObj).sort((a,b) => tempObj[a]-tempObj[b]).forEach((symbol) => {  	//  descending sort
var temp={}
if(symbol !='NIFTY 50' && symbol !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=symbol.replace(/NIFTY /g,'')
}
else{
	temp["label"]=symbol
}
	
		//temp["y"]=tempObj[symbol]; 
		temp["y"]= Math.abs( tempObj[symbol] ); 
		if(tempObj[symbol]<0) 
		{
			temp["color"]="#cd5652"
		}
		else if(tempObj[symbol]>0) 
		{
			temp["color"]="#3a7dd4"
		}
		else if(tempObj[symbol]==0) 
		{
			temp["color"]="black"
		}
		
		dataPointsArray.push(temp)
	});
	
/*
Object.keys(tempObj).sort((a,b) => tempObj[b]-tempObj[a]).forEach((symbol) => {  	//  descending sort
var temp={}
var sectorName = symbol.replace(/_/g,' ')
if(sectorName !='NIFTY 50' && sectorName !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=sectorName.replace(/NIFTY /g,'')
}
else{
	temp["label"]=sectorName
}
	
		temp["y"]=indicesPerformanceObject[symbol][9]; 
		temp["color"]="#089981"
			
		dataPointsArrayAdvances.push(temp)
		//console.log(symbol, preMarketSectorObj[symbol]["advances"])
	});
	
Object.keys(tempObj).sort((a,b) => tempObj[b]-tempObj[a]).forEach((symbol) => {  	//  descending sort
var temp={}
var sectorName = symbol.replace(/_/g,' ')
if(sectorName !='NIFTY 50' && sectorName !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=sectorName.replace(/NIFTY /g,'')
}
else{
	temp["label"]=sectorName
}
	
		temp["y"]=indicesPerformanceObject[symbol][10]; 
		temp["color"]="#cd5652"
		
	
		
		dataPointsArrayDeclines.push(temp)
		
	});	
	
Object.keys(tempObj).sort((a,b) => tempObj[b]-tempObj[a]).forEach((symbol) => {  	//  descending sort
var temp={}
var sectorName = symbol.replace(/_/g,' ')
if(sectorName !='NIFTY 50' && sectorName !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=sectorName.replace(/NIFTY /g,'')
}
else{
	temp["label"]=sectorName
}
	
		temp["y"]=indicesPerformanceObject[symbol][11]; 
	
		temp["color"]="#cbba4d"
		
		
		dataPointsArrayUnchanged.push(temp)
	});
	
	*/
// this section is for plotting indices chart for simple perchange change of single column bar
var chart = new CanvasJS.Chart("IndicesPerformanceChart", {
	animationEnabled: false,
	theme: "dark2", // "light1", "light2", "dark1", "dark2"
	title: {
		//text: "GDP Growth Rate - 2016"
	},
	subtitles: [{
			//text: "Subtitle 1"
		  },{
			text:  returnedDataObj['timestamp'].split(' ')[0] +' | '+ selectedIndicesTimeValues +' | '+returnedDataObj['timestamp'].split(' ')[1],
			//verticalAlign: "top",

			 //horizontalAlign: "right",
	
			 //fontSize: 15,
			 fontSize: 13,
			//dockInsidePlotArea: true
			dockInsidePlotArea: false
	}],
	
	toolTip: {
			//fontSize: 19,
			fontSize: 15,
	},
	axisY: {
		//title: "Growth Rate (in %)",
		//includeZero: true,
		//suffix: "%",
		gridThickness: 0.1,
		//labelFontSize: 18,
		labelFontSize: 11, // bottom size for change%
	},
	axisX: {
		interval: 1,
		//title: "Countries"
		includeZero: true,
		 //labelFontSize: 17,
		 labelFontSize: 11, // vertical axis size for text
		 //labelFontWeight: "bold",
	},
	dataPointWidth: 9,
	data: [{
		//indexLabel: "{y}",
		//indexLabelFontSize: 18,
		//click: onClick,
		//type: "column",
		type: "bar",
		yValueFormatString: "#,##0.0#\"%\"",
		dataPoints: dataPointsArray
	}]
});


console.log("dataPointsArray",dataPointsArray)
chart.render();
//chart2.render();

} // showIndicesPerformanceChart ENDS HERE

</script>
<!-- Indices Code Ends Here -->


<!-- Delivery EOD Code Starts Here -->

<style>    .spaceBetweenTables { border: 2px solid #4b4d4e;height: 518px;overflow-y: scroll;background-color: #32373a; }     .greenHeaderClass{   color: #ffffff;   background: #27ae60;   } .blueHeaderClass{   color: #ffffff;   background: #3a7dd4;    }  caption {	white-space: nowrap;  text-align: center; color: #ffffff; height: px; padding-top: 0rem; padding-bottom: 0rem;	}	</style>


<script>
var dataObjectForHeatChart={}
var sectorStockNamesObj = {}
var allBanksStocksObj ={}

function setDeliverySelectorTimeValues( passedValue )
{
	/*
	var tradingDate = document.getElementById('tradingDate').value
	var timeValuesArray = firestoreIndexObj[ tradingDate ]['Index']['spurts_in_open_interest_by_underlyings']
	var selectElementRef = document.getElementById("spurtsTimeValues");
	
	handleTimeValues( passedValue, timeValuesArray, selectElementRef, getSpurtsEquityData )
	
	*/
	getDeliveryData()
}


async function getDeliveryData( passedValue )
{
	//var tradingDate = document.getElementById('tradingDate').value
	var selectedMonthYear = document.getElementById('monthYear').value
	var selectedTradingDate = document.getElementById('tradingDate').value
	var selectedAvgDays = Number( document.getElementById("avgDays").value )
	/*
	var selectedSpurtsTimeRef = document.getElementById('spurtsTimeValues')
	var selectedSpurtsTimeValue = selectedSpurtsTimeRef.value

	var docPathForSpurts = '/'+selectedMonthYear+'/'+selectedTradingDate+'/spurts_in_open_interest_by_underlyings/'+selectedSpurtsTimeValue
	var spurtsDataObj = await fetchFirebaseDocData( docPathForSpurts )
	
	//console.log( "spurtsDataObj",JSON.parse( spurtsDataObj['data'] ) )
	//console.log( "spurtsDataObjPrevious",JSON.parse( spurtsDataObjPrevious['data'] ) )
	//showIndicesPerformanceChart ( JSON.parse( dataObj['data'] ) )
	
	var equityTimeValuesArray = firestoreIndexObj[ tradingDate ]['Index']['equity_market']['FnO']
	var equitySyncedTimeValue = syncTimeValues( equityTimeValuesArray, selectedSpurtsTimeValue )
	var docPathForEquity = '/'+selectedMonthYear+'/'+selectedTradingDate+'/equity_market/FnO/'+equitySyncedTimeValue[0]+'/'+equitySyncedTimeValue[0]
	
	//console.log( "docPathForEquity", docPathForEquity )
	var equityDataObj = await fetchFirebaseDocData( docPathForEquity )
	//console.log( "equityDataObj",JSON.parse( equityDataObj['data'] ) )

	var docPathForDeliveryData = '/'+selectedMonthYear+'/'+selectedTradingDate+'/delivery_data/delivery_data'
	var deliveryDataObj = await fetchDeliveryDataDocData( docPathForDeliveryData )
	
	//console.log( "deliveryDataObj",JSON.parse( deliveryDataObj['data'] ) )
	
	
	*/
	var collectionPath = '/'+selectedMonthYear+'/'+selectedTradingDate+'/sector_stockNames/'
	sectorStockNamesObj = await fetchSectorStockNamesCollectionData( collectionPath )
	
	add_Sectors_In_HeatMapSelector( )
	
	var returnedDateWiseObj  = await previousTradingDateObj( Number(selectedAvgDays)+1, selectedTradingDate, ( document.getElementById('useCurrentDateDelivery').checked==true ))
	//var collectionPath = '/'+selectedMonthYear+'/'+selectedTradingDate+'/'
	//var returnedDateWiseObj  = await fetchCalculatedEODDeliveryData( collectionPath )

	//console.log("returnedDateWiseObj",returnedDateWiseObj)
	
	await show_EOD_Delivery_Data( selectedMonthYear, selectedTradingDate, selectedAvgDays, returnedDateWiseObj )
	
	/*
	await show_only_Spurts_Data( selectedSpurtsTimeValue, selectedTradingDate, JSON.parse( equityDataObj['data'] ), JSON.parse( spurtsDataObj['data'] ) , JSON.parse( deliveryDataObj['data'] ) )
	
	if( document.getElementById('indicesWith20DAVOnOff').checked==true || document.getElementById('indicesWithOI20DAVOnOff').checked==true || document.getElementById('indicesWithMoneyOnOff').checked==true )
	{
		//console.log("indicesWith20DAVOnOff condiiotn checked")
		
		var listForIndicesCalculation = document.getElementById('listForIndicesCalculation').value
		if(listForIndicesCalculation=='ALL')
		{
			var docPathForEquity = '/'+selectedMonthYear+'/'+selectedTradingDate+'/equity_market/'+listForIndicesCalculation+'/'+equitySyncedTimeValue[0]+'/'+equitySyncedTimeValue[0]
			equityDataObj = await fetchFirebaseDocData( docPathForEquity )
		}
		else{
		//use already calculated equityDataObj
		}
		
		calculateIndicesData( selectedSpurtsTimeValue, selectedTradingDate, JSON.parse( equityDataObj['data'] ), JSON.parse( spurtsDataObj['data'] ) , JSON.parse( deliveryDataObj['data'] ) )
	}
	*/
	addEventListnerInTables()
}



async function previousTradingDateObj( passedPrevDays=1, passedDate, useCurrentDateDelivery=false )
{
	//var returnedDataObj = await previousTradingDateObj2( 1, '29-Dec-2023' )
	 var loopCondition = true
	 var numberCounter = 0
	 var retryCounter = 0 // retry for any date only 3 times to exit from infinite loop
	 var specifiedPreviousDatesObj = {}
	 var selectedDate = passedDate; 
	 while( loopCondition )
	 {
		 /*
		 if( numberCounter==0 && retryCounter ==0 && useCurrentDateDelivery==false )
		 { // 		 
			 selectedDate = passedDate; 
			 //retryCounter = 0
		 }
		 else if(  numberCounter!=0 || retryCounter >2 ) { // if already retried 3 times then use next trading date
			 //selectedDate = formatDate(new Date(new Date('02-Feb-2023')-1)) ; 
			 selectedDate = formatDate(new Date(new Date(selectedDate)-1)); 
			 retryCounter = 0 
		 }
		 
		 */
		 if( useCurrentDateDelivery==false || numberCounter!=0 || retryCounter >1 ) { // if already retried 3 times then use next trading date
			 //selectedDate = formatDate(new Date(new Date('02-Feb-2023')-1)) ; 
			 selectedDate = formatDate(new Date(new Date(selectedDate)-1)); 
			 retryCounter = 0 
		 }
		 
		 //console.log("selectedDate",selectedDate)
		 var monthYear = getMonthYearFromDate(selectedDate); // Output: "December 2023"
		 
		 //var docPath = '/December 2023/Delivery_Data/29-Dec-2023'
		 var docPath = '/'+monthYear+'/Delivery_Data/'+selectedDate
		 
		 //var allDerivativesDataArray = await fetchDerivativesCollectionData( docPathForSpurts )
		 var deliveryDataObj = await fetchAndSaveDataIDB( docPath );
		 //console.log(deliveryDataObj)
		 
		 if( Object.keys(deliveryDataObj).length>0 )
		 {
			 deliveryDataObj = JSON.parse(deliveryDataObj[ selectedDate ]['data'])
			 specifiedPreviousDatesObj[ selectedDate ] = deliveryDataObj
			 
			 if( ( Number(passedPrevDays) -1 )==numberCounter )
			 { // if got specifed previous trading days data then exit from loop
				 loopCondition = false
			 }
			 
			 numberCounter++;
		 }
		 
		 retryCounter ++;
		 if( 2*Number( passedPrevDays )==retryCounter )
		 {
			// if we don't get data after so many retries then then exit from loop
				 loopCondition = false
		 }
		//console.log("retryCounter",retryCounter, selectedDate )
		
	 }
	 //console.log("specifiedPreviousDatesObj", specifiedPreviousDatesObj)
	 return specifiedPreviousDatesObj;
	 
	 
function formatDate(date) {
	date = new Date(date)
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const day = String(date.getDate()).padStart(2, '0');
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    return `${day}-${month}-${year}`;
}

function getMonthYearFromDate(date) {
	date = new Date(date)
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    return `${month} ${year}`;
}

	// await sleep(200)
 } //  async function previousTradingDateObj( passedPrevDays=1 ) ENDS HERE
 
	
async function show_only_equity_Data( selectedSpurtsTimeValue, selectedTradingDate, equityDataObj, spurtsDataObj, deliveryDataObj )
{
	 document.getElementById('equityDataTableContainer').innerHTML = "";
	
	var selectedValue = selectedSpurtsTimeValue
	//var previousTime=selectedValue.options[selectedValue.selectedIndex - 1] 
	
	var niftyTotalMarketObject = equityDataObj['data']
	var spurtsInOIUnderlyingsObject = spurtsDataObj['data']
	
	//console.log("spurtsInOIUnderlyingsObject",spurtsInOIUnderlyingsObject)

//console.log( selectedSpurtsTimeValue, selectedSpurtsTimeValuePrevious, equityDataObj, equityDataObjPrevious, spurtsDataObj, spurtsDataObjPrevious  )

		var tempObj = {};

	
	  var onlyEquityTableStr = ' <div class=""> <div class="spaceBetweenTablesSpurtsEquity"> <table id="onlyEquityTableStr"> <caption style="caption-side:top"> Intraday Hike | '+selectedTradingDate+' | '+selectedValue+'</caption> <thead> <tr class="tableRowClass">'
	  +'<th>Symbol</th>'
	  +' <th>Chg%</th>'
	   +' <th>LTP</th>'
	  +' <th>T.O.</th>'
	 +' <th>Fac</th>'
	  +' <th>20DAV</th>'
	  +' <th>Money</th>'
	  +' </tr> </thead> <tbody>'
		
		var stocksListArray = []
		stocksListArray = sectorStockNamesObj[ document.getElementById('tableListSelector').value ]
		spurtsInOIUnderlyingsObject = convertSpurtsDataArrayIntoObj( spurtsInOIUnderlyingsObject )
		//console.log("spurtsInOIUnderlyingsObject",spurtsInOIUnderlyingsObject)
		
		//for (var S=0; S<spurtsInOIUnderlyingsObject.length ;S++ ) { // loop for accessing all stocks of 754 stocks
		for (var S=0; S<stocksListArray.length ;S++ ) { // loop for accessing all stocks of 754 stocks
		//var Symbol=spurtsInOIUnderlyingsObject[S]['symbol']
		var Symbol=stocksListArray[S]
		//console.log("Symbol",Symbol)
		//for (var Symbol in niftyTotalMarketObject ) { // loop for accessing all stocks of 754 stocks
		//if( Symbol.includes('NIFTY')==false )
		if( Symbol.includes('NIFTY')==false && niftyTotalMarketObject[Symbol]!=undefined && spurtsInOIUnderlyingsObject[Symbol]!=undefined )
		{
		var symbolArray = niftyTotalMarketObject[Symbol] //for short-handing
        //var spurtsSymbolArray = spurtsInOIUnderlyingsObject[S] //for short-handing
        var spurtsSymbolArray = spurtsInOIUnderlyingsObject[Symbol] //for short-handing
	
	var SpurtValvsOI = spurtsSymbolArray["total"] / spurtsSymbolArray["latestOI"]
	var average20DaysValue = deliveryDataObj["Symbols"][Symbol]["calculatedData"]["averageValues"]["twentyDays"]
	var EqtyValvs20DAyVal = ( (symbolArray["totalTradedValue"] ) / average20DaysValue)
	
	var WFactor =( EqtyValvs20DAyVal + SpurtValvsOI ).toFixed(2)
	var twentyDAV =( symbolArray["totalTradedValue"]  / average20DaysValue).toFixed(2)
	var money = Number( ( Number(symbolArray["pChange"] ) * Number(twentyDAV) ).toFixed(2) )
	var Fac = Math.abs( twentyDAV * symbolArray['pChange'] ).toFixed(2)
	 
	 var rankForHeatMap;

		rankForHeatMap = Math.abs( money )
	
	
		//this block of code is for sectors heatMap chart. (START)
		//this block adds stocks in a object with few values. this code was written on 7-Jan-2023
		{
			//dataObjectForHeatChart["selectedTime"] =selectedValue.value
			dataObjectForHeatChart["selectedTime"] =selectedValue
			dataObjectForHeatChart["selectedTradingDate"] =selectedTradingDate
		   var colorValue;
		   var dataLabelFontColor="white";
		   
		if(symbolArray["pChange"]>=0)
	   {
		   if( symbolArray["pChange"]>=0 && symbolArray["pChange"]<=0.5)
		   {
			   colorValue = '#7cb67e' 
			  // dataLabelFontColor="black"
		   }
		   else if( symbolArray["pChange"]>0.5 && symbolArray["pChange"]<=1)
		   {
			   colorValue = '#6cac6e'
		   } 
		   else if( symbolArray["pChange"]>1 && symbolArray["pChange"]<=2)
		   {
			    colorValue = '#5ca35e'
		   }
		   else if( symbolArray["pChange"]>2)
		   {
			   colorValue = '#539355'
		   }
			   
		  
		   dataObjectForHeatChart[Symbol] ={
			  parent: 'Green',
			 name: Symbol,
			 pChange:symbolArray["pChange"],
			 value: Number(rankForHeatMap),
			 //colorValue: Number(symbolArray["pChange"])
			 color: colorValue,
			 
			 dataLabels: {
				 shadow: false,
				 color: dataLabelFontColor //data label font color
				 //format: '{name pChange} %'
			 }
		 }
		   
		 
	   }
	   else
	   {
		   if( symbolArray["pChange"]>=-0.5 && symbolArray["pChange"]<0)
		   {
			   colorValue = '#d4777a'
			   //dataLabelFontColor="black"
		   }
		   else if( symbolArray["pChange"]>-1 && symbolArray["pChange"]<=-0.5)
		   {
			   colorValue = '#ce6467'
		   }
		   else if( symbolArray["pChange"]>-2 && symbolArray["pChange"]<=-1)
		   {
			   colorValue = '#ca575a'
		   }
		   else if( symbolArray["pChange"]<-2)
		   {
			   colorValue = '#c85155'
		   }
			   
			 dataObjectForHeatChart[Symbol] ={
			  parent: 'Red',
			 name: Symbol,
			 pChange:symbolArray["pChange"],
			 value: Number(rankForHeatMap),
			 //colorValue: Number(symbolArray["pChange"])
			 color: colorValue,
			 
			 dataLabels: {
				  shadow: false,
				 color: dataLabelFontColor, //data label font color
				 //format: '{name pChange} %'
			 }
		 }
		  
		  
	   }
		
		}	   	//this block of code is for sectors heatMap chart. (END)
		  
		 
		 function printDataStr(){
			onlyEquityTableStr +='<tr class="item"><td>'
			 +Symbol
			 +'</td><td>'
			+ symbolArray['pChange']  //pchange
			 +'</td><td>'
			 +symbolArray['lastPrice']  //lastPrice
			 +'</td><td>'
			 +( symbolArray['totalTradedValue'] / 1000000).toFixed(0)  //(symbolArray[8] / 10000000).toFixed(2) //totalTradedValue
		 +'</td><td>'
		 + Fac
		+'</td><td>'
		+ twentyDAV
		+'</td><td>'
		+ WFactor
		+'</td></tr>'
			
		
		}

		 var conditionResult
	
		 if( document.getElementById('pChngConditionOnOff').checked==true && document.getElementById('preOpenConditionOnOff').checked==true )
		 {
		 var checkByInput = document.getElementById("checkByInput").value
		 if( checkByInput=='% Chng' )
		 {
			conditionResult = checkCondition( Number(symbolArray['pChange']) )
		 }
		 else if( checkByInput=='Fac' )
		 {
			conditionResult = checkCondition( Number( Fac ) )
		 }
		 else if( checkByInput=='20DAV' )
		 {
			conditionResult = checkCondition( Number( twentyDAV ) )
		 }
		 else if( checkByInput=='Money' )
		 {
			conditionResult = checkCondition( Number( WFactor ) )
		 }
		 
		 var preOpen = Math.abs (((symbolArray['open'] - symbolArray['previousClose'])/symbolArray['previousClose'])*100).toFixed(3)
			 
		 if( conditionResult==true && preOpen <= Number(preOpenPChng.value) )
		 {
		 printDataStr()
		 //console.log("preopen + other conditions")
		 }
		}
		else if( document.getElementById('pChngConditionOnOff').checked==true )
		 {
		 var checkByInput = document.getElementById("checkByInput").value
		 if( checkByInput=='% Chng' )
		 {
			conditionResult = checkCondition( Number(symbolArray['pChange']) )
		 }
		 else if( checkByInput=='Fac' )
		 {
			conditionResult = checkCondition( Number( Fac ) )
		 }
		 else if( checkByInput=='20DAV' )
		 {
			conditionResult = checkCondition( Number( twentyDAV ) )
		 }
		 else if( checkByInput=='Money' )
		 {
			conditionResult = checkCondition( Number( WFactor ) )
		 }
		 
		 
		 if( conditionResult==true )
		 {
		 printDataStr()
		 }
		}
		else if( document.getElementById('preOpenConditionOnOff').checked==true )
		 {
		 //var preOpenConditionResult = checkCondition( Number(symbolArray['pChange']) )
		 //console.log(symbolArray)
		 var preOpen = Math.abs (((symbolArray['open'] - symbolArray['previousClose'])/symbolArray['previousClose'])*100).toFixed(3)
		 //console.log(Symbol,preOpen, Number(preOpenPChng.value) )
		 if( preOpen <= Number(preOpenPChng.value) )
		 {
		 printDataStr()
		 }
		}
		else{
			 printDataStr()
		}
	
	}
		} //for Loop ENDS HERE
		
		onlyEquityTableStr +=' </tbody> </table>    </div>  </div>'
		
	document.getElementById('equityDataTableContainer').innerHTML = onlyEquityTableStr
	 //addEventListnerInTables()
	 add_Sectors_In_HeatMapSelector( )
}	//	show_volume_value_spike_Data() Function ENDS HERE

async function show_EOD_Delivery_Data( selectedMonthYear, selectedTradingDate, selectedAvgDays, returnedDateWiseObj )
{
	 document.getElementById('deliveryDataTableContainer').innerHTML = "";

	//var onlySpurtsSelectedTime = selectedSpurtsTimeValue
	//var spurtsInOIUnderlyingsObject = spurtsDataObj['data']
	//var niftyTotalMarketObject = equityDataObj ['data']
	var selectedDeliveryTradingDate =  Object.keys(returnedDateWiseObj)[0]
	//var selectedDateDeliveryObj = returnedDateWiseObj[ Object.keys(returnedDateWiseObj)[0] ]['Symbols']
	var selectedDateDeliveryObj = returnedDateWiseObj[ selectedDeliveryTradingDate ]['Symbols']
	
	//console.log('returnedDateWiseObj', returnedDateWiseObj)
	
	var aggergatedDeliveryQntyObj = {}
	for ( var date in returnedDateWiseObj )
	{
		//if( date!=selectedTradingDate && date!= undefined)
		if( date!=selectedDeliveryTradingDate && date!= undefined)
		{
			var dateObj = returnedDateWiseObj[ date ]['Symbols']
			for( var stockName in dateObj )
			{
				var symbolObj = dateObj[ stockName ] //for short-handing
				if( symbolObj != undefined )
				{
					//11: "deliverable_quantity"
					if( aggergatedDeliveryQntyObj[ stockName ] ==undefined )
					{
						//aggergatedDeliveryQntyObj[ stockName ] = symbolObj[ 'deliverable_quantity' ]
						aggergatedDeliveryQntyObj[ stockName ] = {
							'deliverable_quantity': symbolObj[ 'deliverable_quantity' ],
							'deliverable_percentage': symbolObj[ 'deliverable_percentage' ]
						}
						
					}
					else
					{
						//aggergatedDeliveryQntyObj[ stockName ] += symbolObj[ 'deliverable_quantity' ]
						aggergatedDeliveryQntyObj[ stockName ]['deliverable_quantity'] += symbolObj[ 'deliverable_quantity' ]
						aggergatedDeliveryQntyObj[ stockName ]['deliverable_percentage'] += symbolObj[ 'deliverable_percentage' ]
					}
					
				}

			}
		}
		
	}
	
	//console.log( "aggergatedDeliveryQntyObj", aggergatedDeliveryQntyObj )
	
	//Object.fromEntries( Object.entries(FnOList).sort( (a,b) => b[1] - a[1] ) )   // for sorting object ascending
	//Object.fromEntries( Object.entries(FnOList).sort( (a,b) => a[1] - b[1] ) )   // for sorting object descending

	//var tablesStr =  '<div class=""><div class="spaceBetweenTablesSpurtsEquity"><table id="onlySpurtsOIUnderlyingsTableStr"><caption style="caption-side:top">High Powered | '+selectedTradingDate+' | '+onlySpurtsSelectedTime+'</caption><thead class="tableRowClass">   <tr>      <th>Symbol</th> <th>EQ Chng(%)</th> <th>EQ TO</th>  <th>TO/OI</th>      <th>Chng (%)</th>      <th>OI</th>   <th>Vol</th>       </tr></thead><tbody>'
	var tablesStr =  ' <div class=""> <div class="spaceBetweenTablesSpurtsEquity"> <table id="eodDeliveryDataTableStr"> <caption style="caption-side:top"> EOD Delivery Data | '+selectedDeliveryTradingDate+'</caption> <thead> <tr class="tableRowClass">'
	  +'<th>Symbol</th>'
	  +'<th>AvgD</th>'
	  +'<th>AvgD%</th>'
	  +' <th>Chg%</th>'
	  +' <th>Delivery%</th>'
	  +' <th>cR</th>'
	  +' <th>p1R</th>'
	  +' <th>p2R</th>'
	 // +' <th>Traded Qty</th>'
	 // +' <th>TO</th>'
	  //+' <th>Del. Qty</th>'
	  
	   
	  +' </tr> </thead> <tbody>'
	
		var stocksListArray = []
		if( document.getElementById('tableListSelector').value=='ALL' )
		{
			stocksListArray = Object.keys(selectedDateDeliveryObj) 
		}
		else
		{
			stocksListArray = sectorStockNamesObj[ document.getElementById('tableListSelector').value ]
		}
		
		//spurtsInOIUnderlyingsObject = convertSpurtsDataArrayIntoObj( spurtsInOIUnderlyingsObject )
	//console.log( 'stocksListArray', stocksListArray )
	
	//for( var F=0; F< Object.keys( spurtsInOIUnderlyingsObject ).length ; F++ ) {
	for( var F=0; F< stocksListArray.length; F++ ) {

	//var symbol = spurtsInOIUnderlyingsObject[F]["symbol"]
	var symbol = stocksListArray[F]
	
	if( symbol.includes('NIFTY')==false && selectedDateDeliveryObj[symbol]!=undefined )
	{
		var symbolObj = selectedDateDeliveryObj[symbol] //for short-handing
		
		var perChange = ( ( ( symbolObj['close_price'] - symbolObj['prev_close'] ) / symbolObj['prev_close'] ) * 100 ).toFixed(2)
		
		/*
		var perChangeStr = ( ( ( symbolObj['close_price'] - symbolObj['prev_close'] ) / symbolObj['prev_close'] ) * 100 ).toFixed(2)
		if ( perChangeStr < 0 )// % change in red
		{
			perChangeStr ='<td class="redClass">'
			+perChangeStr // % change
			 +'</td><td>'
		}
		else // % change in green
		{
			perChangeStr ='<td class="greenClass">'
			+perChangeStr // % change
			 +'</td><td>'
		}
		*/
		
		
		function printDataStr()
		{
		
		//console.log(symbol )
		
			var DayHigh = symbolObj ['high_price']
			var DayLow = symbolObj ['low_price']
			var DayRange =( ( (DayHigh - DayLow) / DayLow) *100).toFixed(2) 
			
			var prev1DayHigh = returnedDateWiseObj[ Object.keys(returnedDateWiseObj)[1] ]['Symbols'][ symbol ] ['high_price']
			var prev1DayLow =  returnedDateWiseObj[ Object.keys(returnedDateWiseObj)[1] ]['Symbols'][ symbol ]  ['low_price']
			var prev1DayRange =( ( (prev1DayHigh - prev1DayLow) / prev1DayLow) *100).toFixed(2) 
		
			var prev2DayHigh = returnedDateWiseObj[ Object.keys(returnedDateWiseObj)[2] ]['Symbols'][ symbol ] ['high_price']
			var prev2DayLow =  returnedDateWiseObj[ Object.keys(returnedDateWiseObj)[2] ]['Symbols'][ symbol ]  ['low_price']
			var prev2DayRange =( ( (prev2DayHigh - prev2DayLow) / prev2DayLow) *100).toFixed(2) 
		
		
		tablesStr +='<tr class="item"><td>'
		+ symbol
		+'</td><td>'
		+ ( aggergatedDeliveryQntyObj[ symbol ] ? (  symbolObj['deliverable_quantity'] / ( aggergatedDeliveryQntyObj[ symbol ]['deliverable_quantity'] / Number(selectedAvgDays) ) ).toFixed(2) : 0 )
		+'</td><td>'
		+ ( aggergatedDeliveryQntyObj[ symbol ] ? (  symbolObj['deliverable_percentage'] / ( aggergatedDeliveryQntyObj[ symbol ]['deliverable_percentage'] / Number(selectedAvgDays) ) ).toFixed(2) : 0 )
		+'</td><td>'
		+ perChange 
		+'</td><td>'
		+symbolObj['deliverable_percentage']
		+'</td><td>'
		+DayRange
		+'</td><td>'
		+prev1DayRange
		+'</td><td>'
		+prev2DayRange
		//+'</td><td>'
		//+( symbolObj['volume'] / 1000 ).toFixed(0) 
		//+'</td><td>'
		//+( symbolObj['turnover'] / 100000 ).toFixed(0)
		//+'</td><td>'
		//+symbolObj['deliverable_quantity']
		
		+'</td></tr>'
			}
			
	printDataStr()
	
		
	}
	
	
	
	
	}
	tablesStr +=' </tbody> </table>    </div>  </div>'


	
	 document.getElementById('deliveryDataTableContainer').innerHTML = tablesStr;
	 //document.getElementById('allSpurtsUnderlyingsColumnsContainer').innerHTML += tablesStrForNegative;
	 
	 
	if( document.getElementById('deliveryStockSymbol').options.length<=1 )
	{
		document.getElementById("deliveryStockSymbol").innerHTML=''
		var option = document.createElement("option");
		option.value = "Select";
		option.text =   "Select";
		document.getElementById("deliveryStockSymbol").add(option);
		
		for( var StockName in selectedDateDeliveryObj )
		{
			var option = document.createElement("option");
			option.value = StockName;
			option.text =  StockName;
			document.getElementById("deliveryStockSymbol").add(option);
		}
		//console.log( selectedDayDataObj )
	}
	 
	// await addEventListnerInTables()
}	//	show_spurts_in_oi_underlyings_Data() Function ENDS HERE


async function fetchEODDeliveryData(docPath) {

  var firebaseFetchedDocsLocalStorage = localStorage.getItem('firebaseFetchedDocs');
  var firebaseFetchedDocs = firebaseFetchedDocsLocalStorage ? JSON.parse(firebaseFetchedDocsLocalStorage) : {};

  if (firebaseFetchedDocs[docPath] !== undefined) {
    return firebaseFetchedDocs[docPath];
  } 
  else {
  
	var selectedMonthYear = document.getElementById('monthYear').value
	var selectedTradingDate = document.getElementById('tradingDate').value
	var selectedAvgDays = Number( document.getElementById("avgDays").value )
	var returnedDateWiseObj  = await previousTradingDateObj( Number(selectedAvgDays)+1, selectedTradingDate, ( document.getElementById('useCurrentDateDelivery').checked==true ))
	
	var selectedDeliveryTradingDate =  Object.keys(returnedDateWiseObj)[0]
	//var selectedDateDeliveryObj = returnedDateWiseObj[ Object.keys(returnedDateWiseObj)[0] ]['Symbols']
	var selectedDateDeliveryObj = returnedDateWiseObj[ selectedDeliveryTradingDate ]['Symbols']
	
	
	var aggergatedDeliveryQntyObj = {}
	for ( var date in returnedDateWiseObj )
	{
		//if( date!=selectedTradingDate && date!= undefined)
		if( date!=selectedDeliveryTradingDate && date!= undefined)
		{
			var dateObj = returnedDateWiseObj[ date ]['Symbols']
			for( var stockName in dateObj )
			{
				var symbolObj = dateObj[ stockName ] //for short-handing
				if( symbolObj != undefined )
				{
					//11: "deliverable_quantity"
					if( aggergatedDeliveryQntyObj[ stockName ] ==undefined )
					{
						//aggergatedDeliveryQntyObj[ stockName ] = symbolObj[ 'deliverable_quantity' ]
						aggergatedDeliveryQntyObj[ stockName ] = {
							'deliverable_quantity': symbolObj[ 'deliverable_quantity' ],
							'deliverable_percentage': symbolObj[ 'deliverable_percentage' ]
						}
						
					}
					else
					{
						//aggergatedDeliveryQntyObj[ stockName ] += symbolObj[ 'deliverable_quantity' ]
						aggergatedDeliveryQntyObj[ stockName ]['deliverable_quantity'] += symbolObj[ 'deliverable_quantity' ]
						aggergatedDeliveryQntyObj[ stockName ]['deliverable_percentage'] += symbolObj[ 'deliverable_percentage' ]
					}
					
				}

			}
		}
		
	}
	
	  if (aggergatedDeliveryQntyObj!=undefined) {
          var dataObj = doc.data();

          // Store the fetched document in localStorage
          firebaseFetchedDocs[docPath] = dataObj;

          // Attempt to update localStorage and handle quota exceeded error
          var maxAttempts = Object.keys(firebaseFetchedDocs).length;
          var currentAttempt = 0;

          while (currentAttempt < maxAttempts) {
            try {
              localStorage.setItem('firebaseFetchedDocs', JSON.stringify(firebaseFetchedDocs));
              break; // Successfully stored the new entry
            } catch (e) {
              // Remove oldest entry
              var oldestEntryKey = Object.keys(firebaseFetchedDocs)[0];
              delete firebaseFetchedDocs[oldestEntryKey];
              currentAttempt++;
            }
          }

          if (currentAttempt === maxAttempts) {
            console.log("Unable to store the new entry due to quota limitations.");
          }

          return dataObj;
        } else {
          console.log("Document does not exist");
          return null;
        }
	
	//console.log( "aggergatedDeliveryQntyObj", aggergatedDeliveryQntyObj )
	
    //var docRef = db.doc(docPath);

    // Retrieve the document from Firebase
    return docRef
      .get()
      .then(function (doc) {
        if (doc.exists) {
          var dataObj = doc.data();

          // Store the fetched document in localStorage
          firebaseFetchedDocs[docPath] = dataObj;

          // Attempt to update localStorage and handle quota exceeded error
          var maxAttempts = Object.keys(firebaseFetchedDocs).length;
          var currentAttempt = 0;

          while (currentAttempt < maxAttempts) {
            try {
              localStorage.setItem('firebaseFetchedDocs', JSON.stringify(firebaseFetchedDocs));
              break; // Successfully stored the new entry
            } catch (e) {
              // Remove oldest entry
              var oldestEntryKey = Object.keys(firebaseFetchedDocs)[0];
              delete firebaseFetchedDocs[oldestEntryKey];
              currentAttempt++;
            }
          }

          if (currentAttempt === maxAttempts) {
            console.log("Unable to store the new entry due to quota limitations.");
          }

          return dataObj;
        } else {
          console.log("Document does not exist");
          return null;
        }
      })
      .catch(function (error) {
        console.log("Error getting document:", error);
        return null;
      });
  }
}


async function fetchCalculatedEODDeliveryData( collectionPath ) {
  try {
  
	var firebaseFetchedDocsLocalStorage = localStorage.getItem('firebaseFetchedDocs');
	var firebaseFetchedDocs = firebaseFetchedDocsLocalStorage ? JSON.parse(firebaseFetchedDocsLocalStorage) : {};

	var selectedMonthYear = document.getElementById('monthYear').value
	var selectedTradingDate = document.getElementById('tradingDate').value
	var selectedAvgDays
	if( document.getElementById("avgDays") )
		selectedAvgDays = Number( document.getElementById("avgDays").value )
	else
		selectedAvgDays = 10
	
	var useCurrentDateDelivery
	if( document.getElementById("useCurrentDateDelivery") )
		useCurrentDateDelivery = ( document.getElementById('useCurrentDateDelivery').checked==true )
	else
		useCurrentDateDelivery = false
	
	collectionPath = collectionPath+selectedAvgDays+useCurrentDateDelivery
	
	var localStorageForCalculatedEODDeliveryData = localStorage.getItem('calculatedEODDeliveryData')
	if( localStorageForCalculatedEODDeliveryData!=null && JSON.parse(localStorageForCalculatedEODDeliveryData) [collectionPath]!=undefined )
	{
		 var sectorStockNamesObj = {};
		var allDocsDataObj = JSON.parse(localStorageForCalculatedEODDeliveryData) [collectionPath]
		console.log("getting from localstorage")
		return allDocsDataObj;
	}
	else {
  //var collectionRef = db.collection(collectionPath);
  var sectorStockNamesObj = {};

	
	var returnedDateWiseObj  = await previousTradingDateObj( Number(selectedAvgDays)+1, selectedTradingDate, useCurrentDateDelivery )
	
	var selectedDeliveryTradingDate =  Object.keys(returnedDateWiseObj)[0]
	//var selectedDateDeliveryObj = returnedDateWiseObj[ Object.keys(returnedDateWiseObj)[0] ]['Symbols']
	var selectedDateDeliveryObj = returnedDateWiseObj[ selectedDeliveryTradingDate ]['Symbols']
	
	
	var aggergatedDeliveryQntyObj = {}
	for ( var date in returnedDateWiseObj )
	{
		//if( date!=selectedTradingDate && date!= undefined)
		if( date!=selectedDeliveryTradingDate && date!= undefined)
		{
			var dateObj = returnedDateWiseObj[ date ]['Symbols']
			for( var stockName in dateObj )
			{
				var symbolObj = dateObj[ stockName ] //for short-handing
				if( symbolObj != undefined )
				{
					//11: "deliverable_quantity"
					if( aggergatedDeliveryQntyObj[ stockName ] ==undefined )
					{
						//aggergatedDeliveryQntyObj[ stockName ] = symbolObj[ 'deliverable_quantity' ]
						aggergatedDeliveryQntyObj[ stockName ] = {
							'deliverable_quantity': symbolObj[ 'deliverable_quantity' ],
							'deliverable_percentage': symbolObj[ 'deliverable_percentage' ]
						}
						
					}
					else
					{
						//aggergatedDeliveryQntyObj[ stockName ] += symbolObj[ 'deliverable_quantity' ]
						aggergatedDeliveryQntyObj[ stockName ]['deliverable_quantity'] += symbolObj[ 'deliverable_quantity' ]
						aggergatedDeliveryQntyObj[ stockName ]['deliverable_percentage'] += symbolObj[ 'deliverable_percentage' ]
					}
					
				}

			}
		}
		
	}
	console.log("aggergatedDeliveryQntyObj",aggergatedDeliveryQntyObj)
	for( var symbol in selectedDateDeliveryObj )
	{
		var symbolObj = selectedDateDeliveryObj[symbol] //for short-handing
		console.log( symbol )
		if( aggergatedDeliveryQntyObj[ symbol ] )
		{
		var averageDeliveryQuantity = (  symbolObj['deliverable_quantity'] / ( aggergatedDeliveryQntyObj[ symbol ]['deliverable_quantity'] / Number(selectedAvgDays) ) ).toFixed(2)
		var averageDeliveryPercentage = (  symbolObj['deliverable_percentage'] / ( aggergatedDeliveryQntyObj[ symbol ]['deliverable_percentage'] / Number(selectedAvgDays) ) ).toFixed(2)
		
		aggergatedDeliveryQntyObj[ symbol ] = {
			"averageDeliveryQuantity":averageDeliveryQuantity,
			"averageDeliveryPercentage":averageDeliveryPercentage,
		}
		}
	}
	
  try {
   
          // Attempt to update localStorage and handle quota exceeded error (Starts Here)
          var maxAttempts = Object.keys(firebaseFetchedDocs).length;
          var currentAttempt = 0;

          while (currentAttempt < maxAttempts) {
            try {
               //localStorage.setItem('sectorStockNames', JSON.stringify( {[collectionPath]:sectorStockNamesObj} ));
               //localStorage.setItem('calculatedEODDeliveryData', JSON.stringify( {[collectionPath]:JSON.stringify(aggergatedDeliveryQntyObj) } ));
               localStorage.setItem('calculatedEODDeliveryData', JSON.stringify( {[collectionPath]:aggergatedDeliveryQntyObj } ));
              break; // Successfully stored the new entry
            } catch (e) {
			console.log(e)
				//document.getElementById('messages').innerHTML = e;
              // Remove oldest entry
              var oldestEntryKey = Object.keys(firebaseFetchedDocs)[0];
			  //console.log("oldestEntryKey", oldestEntryKey)
              delete firebaseFetchedDocs[oldestEntryKey];
			  //console.log("firebaseFetchedDocs", firebaseFetchedDocs)
			  localStorage.setItem('firebaseFetchedDocs', JSON.stringify(firebaseFetchedDocs));
              currentAttempt++;
            }
          }
		// Attempt to update localStorage and handle quota exceeded error (Ends Here)
	
    return aggergatedDeliveryQntyObj;
  } catch (error) {
    console.log("Error getting documents: ", error);
    //return null;
    return {};
  }
  }
  
   } catch (error) {
    console.log("Error getting documents: ", error);
    //return null;
    return {};
  }
  
}

async function showPerticularStocksDeliveryDataInTable()
{
	 document.getElementById('perticularStockDeliveryTableContainer').innerHTML = "";
	 
	 var selectedDeliveryStockSymbol = document.getElementById("deliveryStockSymbol").value
	var selectedMonthYear = document.getElementById('monthYear').value
	var selectedTradingDate = document.getElementById('tradingDate').value
	var selectedAvgDays = Number( document.getElementById("avgDays").value )
	var selectedPreviousTradingDays = Number( document.getElementById("previousTradingDays").value )


	var returnedDateWiseObj = await previousTradingDateObj( Number(selectedPreviousTradingDays)+1, selectedTradingDate, ( document.getElementById('useCurrentDateDelivery').checked==true ))
	//console.log("returnedDateWiseObj",returnedDateWiseObj)
	
	var selectedDeliveryTradingDate =  Object.keys(returnedDateWiseObj)[0]
	//var selectedDateDeliveryObj = returnedDateWiseObj[ Object.keys(returnedDateWiseObj)[0] ]['Symbols']
	var selectedDateDeliveryObj = returnedDateWiseObj[ selectedDeliveryTradingDate ]['Symbols']
	
	
	

	//Object.fromEntries( Object.entries(FnOList).sort( (a,b) => b[1] - a[1] ) )   // for sorting object ascending
	//Object.fromEntries( Object.entries(FnOList).sort( (a,b) => a[1] - b[1] ) )   // for sorting object descending

	//var tablesStr =  '<div class=""><div class="spaceBetweenTablesSpurtsEquity"><table id="onlySpurtsOIUnderlyingsTableStr"><caption style="caption-side:top">High Powered | '+selectedTradingDate+' | '+onlySpurtsSelectedTime+'</caption><thead class="tableRowClass">   <tr>      <th>Symbol</th> <th>EQ Chng(%)</th> <th>EQ TO</th>  <th>TO/OI</th>      <th>Chng (%)</th>      <th>OI</th>   <th>Vol</th>       </tr></thead><tbody>'
	var tablesStr =  ' <div class=""> <div class="spaceBetweenTablesSpurtsEquity"> <table id="perticularStocksDeliveryDataTableStr"> <caption style="caption-side:top"> Perticular Stock | '+selectedDeliveryStockSymbol+'</caption> <thead> <tr class="tableRowClass">'
	  +'<th>Date</th>'
	  +'<th>AvgD</th>'
	  +'<th>AvgD%</th>'
	  +' <th>Chg%</th>'
	  +' <th>Delivery%</th>'
	  +' <th>Range</th>'
	  //+' <th>Traded Qty</th>'
	 // +' <th>TO</th>'
	  //+' <th>Del. Qty</th>'
	  
	   
	  +' </tr> </thead> <tbody>'
	
		var stocksListArray = []
		stocksListArray = sectorStockNamesObj[ document.getElementById('tableListSelector').value ]
		//spurtsInOIUnderlyingsObject = convertSpurtsDataArrayIntoObj( spurtsInOIUnderlyingsObject )
	//console.log( 'stocksListArray', stocksListArray )
	
	//for( var F=0; F< Object.keys( spurtsInOIUnderlyingsObject ).length ; F++ ) {
	//for( var F=0; F< stocksListArray.length; F++ ) {
	for ( var date in returnedDateWiseObj ) {
	
	
		var returnedDateWiseObj2 = await previousTradingDateObj( Number(selectedAvgDays)+1, date, true )
		//console.log("returnedDateWiseObj2",returnedDateWiseObj2)
	
		//var aggergatedDeliveryQntyObj = {}
		var aggergatedDeliveryQnty = 0
		var aggergatedDeliveryPrcntg = 0
		for ( var date2 in returnedDateWiseObj2 )
		{
			if( date2!=date && date!= undefined && date2!= undefined)
			{
				var symbolArray2 = returnedDateWiseObj2[ date2 ][ selectedDeliveryStockSymbol ] 
				var symbolObj = returnedDateWiseObj2 [ date2 ]['Symbols'][ selectedDeliveryStockSymbol ] 
				if( aggergatedDeliveryQnty==0 )
				{
					aggergatedDeliveryQnty = symbolObj[ 'deliverable_quantity' ]
					aggergatedDeliveryPrcntg = symbolObj[ 'deliverable_percentage' ]
				}
				else
				{
					aggergatedDeliveryQnty += symbolObj[ 'deliverable_quantity' ]
					aggergatedDeliveryPrcntg += symbolObj[ 'deliverable_percentage' ]
				}
			}
			
		}
		
	

	//var symbol = spurtsInOIUnderlyingsObject[F]["symbol"]
	var symbol = selectedDeliveryStockSymbol
	var symbolObj =  returnedDateWiseObj[ date ]['Symbols'][ symbol ]  //for short-handing
		
	if( symbolObj !=undefined )
	{
		
		var perChange = ( ( ( symbolObj['close_price'] - symbolObj['prev_close'] ) / symbolObj['prev_close'] ) * 100 ).toFixed(2)
		
		/*
		var perChangeStr = ( ( ( symbolObj['close_price'] - symbolObj['prev_close'] ) / symbolObj['prev_close'] ) * 100 ).toFixed(2)
		if ( perChangeStr < 0 )// % change in red
		{
			perChangeStr ='<td class="redClass">'
			+perChangeStr // % change
			 +'</td><td>'
		}
		else // % change in green
		{
			perChangeStr ='<td class="greenClass">'
			+perChangeStr // % change
			 +'</td><td>'
		}
		*/
		
		
		function printDataStr()
		{
			var DayHigh = symbolObj ['high_price']
			var DayLow = symbolObj ['low_price']
			var DayRange =( ( (DayHigh - DayLow) / DayLow) *100).toFixed(2) 
		
		
		tablesStr +='<tr class="item"><td>'
		+ date
		+'</td><td>'
		+ (  symbolObj['deliverable_quantity'] / ( aggergatedDeliveryQnty / Number(selectedAvgDays) ) ).toFixed(2)
		+'</td><td>'
		+ (  symbolObj['deliverable_percentage'] / ( aggergatedDeliveryPrcntg / Number(selectedAvgDays) ) ).toFixed(2)
		+'</td><td>'
		+ perChange 
		+'</td><td>'
		+symbolObj['deliverable_percentage']
		+'</td><td>'
		+DayRange
		//+'</td><td>'
		//+( symbolObj['volume'] / 1000 ).toFixed(0) 
		//+'</td><td>'
		//+( symbolObj['turnover'] / 100000 ).toFixed(0)
		//+'</td><td>'
		//+symbolObj['deliverable_quantity']
		
		+'</td></tr>'
			}
			
	printDataStr()
	
		
	}
	
	
	
	
	}
	tablesStr +=' </tbody> </table>    </div>  </div>'


	
	 document.getElementById('perticularStockDeliveryTableContainer').innerHTML = tablesStr;
	 //document.getElementById('allSpurtsUnderlyingsColumnsContainer').innerHTML += tablesStrForNegative;
	 
	// await addEventListnerInTables()
}	//	show_spurts_in_oi_underlyings_Data() Function ENDS HERE




function convertSpurtsDataArrayIntoObj( dataArray )
{
	var dataObject={}
	for (var S=0; S<dataArray.length ;S++ ) {
	var Symbol=dataArray[S]['symbol']
	dataObject [ Symbol ] = dataArray[S]
	}
	//console.log( "dataArray length", dataArray.length, "dataObject length", Object.keys(dataObject).length )
	return dataObject
}

function add_Sectors_In_HeatMapSelector( )
{
	//console.log( "sectorStockNamesObj", sectorStockNamesObj)
	
	if( sectorStockNamesObj !=undefined)
	{
	if( document.getElementById("tableListSelector").getElementsByTagName('option').length <=1 )
	{
	//document.getElementById("heatMapSectorSelector").innerHTML = "";
	document.getElementById("tableListSelector").innerHTML = "";
	
	var option = document.createElement("option");
	option.value = "ALL";
	option.text = "ALL";
	document.getElementById("tableListSelector").add(option);
	
	
	
	for ( var sectorName in sectorStockNamesObj ) {
		
		if( sectorName != 'Template' )
		{
		var option = document.createElement("option");
		option.value = sectorName;
		option.text = sectorName;
		//document.getElementById("heatMapSectorSelector").add(option);
		
		var option = document.createElement("option");
		option.value = sectorName;
		option.text = sectorName;	
		document.getElementById("tableListSelector").add(option);
		}
	}
	//document.getElementById('heatMapSectorSelector').value=document.getElementById('heatMapSectorSelector').getElementsByTagName('option')[2].value
	//document.getElementById('heatMapSectorSelector').value="NIFTY_50"
	document.getElementById('tableListSelector').value="FnO"
	}
	
	//showHeatMapChart(sectorStockNamesObj)
	//showHeatMapChart()
	}
	
} // add_Sectors_In_HeatMapSelector() ENDS HERE

async function showHeatMapChart( )
{
	await setHighChartsDarkTheme()
	var sectorDataArrayForHeatChart=[{
      id: 'Green',
      //name: 'Green',
      color: "#EC2500"
    }, {
      id: 'Red',
      //name: 'Red',
      color: "#ECE100"
    }]
	
	var heatMapSectorSelected = document.getElementById("heatMapSectorSelector").value
	var sectorStockArray;
	if( heatMapSectorSelected=='ALL BANKS' )
	{
		
		for( var sector in sectorStockNamesObj )
		{
			if( sector.includes('BANK')==true )
			{
				var sectorStockArray = sectorStockNamesObj [sector]
				for( var s=0;s<sectorStockArray.length;s++)
				{
					var Symbol = sectorStockArray [s]
					allBanksStocksObj [Symbol] = 1
				}
				
			}
		}
		
		sectorStockArray = Object.keys(allBanksStocksObj)
	}
	else {
	sectorStockArray = sectorStockNamesObj [heatMapSectorSelected] 
	}
	for( var s=0;s<sectorStockArray.length;s++)
	{
		var Symbol = sectorStockArray [s]
		//console.log(Symbol)
		if( dataObjectForHeatChart[Symbol] !=undefined )
		{
			sectorDataArrayForHeatChart.push( dataObjectForHeatChart[Symbol] )
		}
	}
	//console.log("sectorDataArrayForHeatChart", sectorDataArrayForHeatChart)
	
	
var H = Highcharts
H.addEvent(H.Legend, 'afterGetAllItems', function(e) {
  e.allItems.splice(2, 6);
});

H.chart('heatMapContainer', {
  colorAxis: {
      stops: [
       
	  [0, '#ff0000'],//red
      [0.5, '#fff'], // white
      [1, '#02ff00']//green
	  
    ],
  },
  legend: {
      enabled: false
    },
  series: [{
	animation: false,
	borderWidth: 0.25,
    //borderColor: '#fff',
    borderColor: '#4b4b4c',
    colorAxis: 0,
    legendType: 'point',
    showInLegend: false,
    type: "treemap",
    layoutAlgorithm: 'squarified',
    alternateStartingDirection: true,
    levels: [{
      level: 1,
      layoutAlgorithm: 'sliceAndDice',
      dataLabels: {
        enabled: false,
        align: 'left',
        verticalAlign: 'top',
        style: {
          fontSize: '15px',
          fontWeight: 'bold'
        }
      }
    }],
    data: sectorDataArrayForHeatChart,
	
  dataLabels: {
		enabled: true,
                format: '{point.name} <br> {point.value}',
			 },
			 
			  events: {
                    click: function (event) {
                        //console.log(event.point.name);
						copyHeatMapList( heatMapSectorSelected, event.point.parent )
                    }
                }
  }],
  tooltip: {
            //headerFormat: 'Temperature<br/>',
            pointFormat: '{point.name} <br> pChange: {point.pChange} <br> Rank: {point.value}'
        },
	
  title: {
    //text: heatMapSectorSelected +' | '+ dataObjectForHeatChart["selectedTime"] +' | '+ mainOIDataObject['Date'],
    text: heatMapSectorSelected +' | '+ dataObjectForHeatChart["selectedTradingDate"] +' | '+ dataObjectForHeatChart["selectedTime"],
	   style: {
                    //color: 'red',
                    fontSize:'15px'
                }
  }
});

}

function setHighChartsDarkTheme()
{

	Highcharts.theme = {
    colors: ['#2b908f', '#90ee7e', '#f45b5b', '#7798BF', '#aaeeee', '#ff0066',
        '#eeaaee', '#55BF3B', '#DF5353', '#7798BF', '#aaeeee'],
    chart: {
        backgroundColor: {
            linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
            stops: [
                [0, '#2a2a2b'],
                [1, '#3e3e40']
            ]
        },
        style: {
     
        },
        plotBorderColor: '#606063'
    },
    title: {
        style: {
            color: '#E0E0E3',
            textTransform: 'uppercase',
            fontSize: '20px'
        }
    },
    subtitle: {
        style: {
            color: '#E0E0E3',
            textTransform: 'uppercase'
        }
    },
    xAxis: {
        gridLineColor: '#707073',
        labels: {
            style: {
                color: '#E0E0E3'
            }
        },
        lineColor: '#707073',
        minorGridLineColor: '#505053',
        tickColor: '#707073',
        title: {
            style: {
                color: '#A0A0A3'
            }
        }
    },
    yAxis: {
        gridLineColor: '#707073',
        labels: {
            style: {
                color: '#E0E0E3'
            }
        },
        lineColor: '#707073',
        minorGridLineColor: '#505053',
        tickColor: '#707073',
        tickWidth: 1,
        title: {
            style: {
                color: '#A0A0A3'
            }
        }
    },
    tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.85)',
        style: {
            color: '#F0F0F0'
        }
    },
    plotOptions: {
        series: {
            dataLabels: {
                color: '#F0F0F3',
                style: {
                    fontSize: '12px'
                }
            },
            marker: {
                lineColor: '#333'
            }
        },
        boxplot: {
            fillColor: '#505053'
        },
        candlestick: {
          
        },
        errorbar: {
            
        }
    },
    legend: {
        backgroundColor: 'rgba(0, 0, 0, 0.5)',
        itemStyle: {
            color: '#E0E0E3'
        },
        itemHoverStyle: {
            color: '#FFF'
        },
        itemHiddenStyle: {
            color: '#606063'
        },
        title: {
            style: {
                color: '#C0C0C0'
            }
        }
    },
    credits: {
        style: {
            color: '#666'
        }
    },
    labels: {
        style: {
            color: '#707073'
        }
    },
    drilldown: {
        activeAxisLabelStyle: {
            color: '#F0F0F3'
        },
        activeDataLabelStyle: {
            color: '#F0F0F3'
        }
    },
    navigation: {
        buttonOptions: {
            symbolStroke: '#DDDDDD',
            theme: {
                fill: '#505053'
            }
        }
    },
    // scroll charts
    rangeSelector: {
        buttonTheme: {
            fill: '#505053',
            stroke: '#000000',
            style: {
              
            },
            states: {
                hover: {
                    fill: '#707073',
                    stroke: '#000000',
                    style: {
                      
                    }
                },
                select: {
                    fill: '#000003',
                    stroke: '#000000',
                    style: {
                        
                    }
                }
            }
        },
        inputBoxBorderColor: '#505053',
        inputStyle: {
            backgroundColor: '#333',
            color: 'silver'
        },
        labelStyle: {
            color: 'silver'
        }
    },
    navigator: {
        handles: {
            backgroundColor: '#666',
            borderColor: '#AAA'
        },
        outlineColor: '#CCC',
        maskFill: 'rgba(255,255,255,0.1)',
        series: {
            color: '#7798BF',
            lineColor: '#A6C7ED'
        },
        xAxis: {
            gridLineColor: '#505053'
        }
    },
    scrollbar: {
        barBackgroundColor: '#808083',
        barBorderColor: '#808083',
        buttonArrowColor: '#CCC',
        buttonBackgroundColor: '#606063',
        buttonBorderColor: '#606063',
        rifleColor: '#FFF',
        trackBackgroundColor: '#404043',
        trackBorderColor: '#404043'
    }
};
	// Apply the theme
	Highcharts.setOptions(Highcharts.theme);

}


function copyHeatMapList( heatMapSectorSelected, greenOrRed )
{
	var symbolObject ={}
	var sectorStockArray;
	if( heatMapSectorSelected=='ALL BANKS' )
	{
		sectorStockArray = Object.keys(allBanksStocksObj)
	}
	else {
	sectorStockArray = sectorStockNamesObj[heatMapSectorSelected]
	}
	

	for( var s=0;s<sectorStockArray.length;s++)
	{
		var Symbol = sectorStockArray [s]
		//console.log(Symbol)
		if( dataObjectForHeatChart[Symbol] !=undefined )
		{
			if( dataObjectForHeatChart[Symbol]["parent"]==greenOrRed )
				symbolObject[Symbol] = dataObjectForHeatChart[Symbol]["value"] //symbol's rank
		}
	}
	
	var stockNames=''
	stockNames= ( 'NSE:'+dataObjectForHeatChart["selectedTime"] +'_'+ heatMapSectorSelected+',' ).replace(/ /g,'_')
	
	Object.keys(symbolObject).sort((a,b) => symbolObject[b]-symbolObject[a]).forEach((symbol) => {    	//  descending sort
		stockNames +='NSE:'+symbol.replace(/-/g,'_').replace(/&amp;/g,'_').replace(/&/g,'_') +','
	});

	//console.log("stockNames",stockNames)
	
	var stockNamesArray = stockNames.split(',')
	var stockNames2 = ''
	
	var copyListNumber = 22
	if(stockNamesArray.length<22)
	copyListNumber=stockNamesArray.length

	for( var s=0;s<copyListNumber;s++)
	{
		stockNames2 += stockNamesArray[s]+',' 
	}
	
	
	//navigator.clipboard.writeText(stockNames);
	navigator.clipboard.writeText(stockNames2);
}


function addOnclickEvent()
{
var tableRows = document.getElementsByTagName('tr')

for( var i=0;i<tableRows.length;i++ )
{
var tableData = tableRows[i].getElementsByTagName('td')[0]
var tableHead = tableRows[i].getElementsByTagName('th')

if( tableData==undefined && tableHead[0] !=undefined )
{
/*
console.log(tableHead[0].innerHTML)
for( var j=0;j<tableHead.length;j++ )
{
var functionStr ="addOnclickEvent();" + tableHead[j].getAttribute('onclick')
 tableHead[j].setAttribute('onclick', functionStr)
 }
 */
}
else
{
var functionStr = "document.getElementById('deliveryStockSymbol').value ='"+tableData.innerHTML+"';showPerticularStocksDeliveryDataInTable();document.getElementById('perticularStockDeliveryTableContainer').scrollIntoView();"
tableData.setAttribute('onclick', functionStr)
}
}
}

function tableSortAndPushData(tableHead,event)
{
	var clicked_heading_index = tableHead.closest('th').cellIndex
	var clicked_table_id=tableHead.closest("table").id
	
	//console.log("clicked heading index "+ clicked_heading_index  )
	//console.log("clicked table index "+ clicked_table_id )
	
	var table=tableHead.closest("table")
   	var fetchedTableData = [];
	table.tBodies[0].getElementsByTagName('tr').length

	for( var tableRow=0;  tableRow<table.tBodies[0].getElementsByTagName('tr').length; tableRow++ )
	{
	var keysValuesObj={}
	var td=(table.tBodies[0].getElementsByTagName('tr')[tableRow]).getElementsByTagName('td')
	for( var tableData=0;  tableData< td.length; tableData++ )
	{
	if(isNaN(td[tableData].innerText) == false )
	{
	keysValuesObj["column"+tableData] = Number( td[tableData].innerText )
	}
	else
	{
	keysValuesObj["column"+tableData] =  td[tableData].innerText 
	}

	}
	
	fetchedTableData.push(keysValuesObj)
	}
	//console.log(fetchedTableData)
	
	
	
	   let element = event.target;
		//  console.log(element)
      let caret, field, reverse;
      if (element.tagName === 'SPAN') {
        caret = element.getElementsByClassName('caret')[0];
 
      }
      else {
        caret = element;
 
      }
	  
	       field = "column"+clicked_heading_index 
		   
      let iconClassName = caret.className;
      clearArrow();
	 // console.log("cleared carets, iconClassName: " + iconClassName)
      if (iconClassName.includes(caretUpClassName)) {
        caret.className = `caret ${caretDownClassName}`;
        reverse = false;
      } else {
		 caret.className = `caret ${caretUpClassName}`;
        reverse = true;
      }

      fetchedTableData.sort(sort_by(field, reverse));
      populateTable(fetchedTableData, clicked_table_id);
	addOnclickEvent()
	} // tableSortAndPushData() ENDS HERE


</script>
<!-- Delivery EOD Code Ends Here -->



<!-- Floating Buttons Code Starts Here -->
<style>		.float{	position:fixed;	width:25px;	height:50px;	bottom:16%;	right:10px;			border-radius:50px;	text-align:center;	}.vertical-centerFloat {   float: right;  margin: 0;  position: sticky;  top: 50%;  -ms-transform: translateY(-50%);  transform: translateY(-50%);	}  .Floatbtn{ margin-top:1px;} </style>
<div class="float"> 	<button class="Floatbtn" onclick="document.getElementById('commonTimeValues').scrollIntoView();"><b><span style="font-size:20px;">&#8593;</span></b></button><br/>	     <button class="Floatbtn" onclick="getFirestoreData('live','')"><b><span style="font-size:20px;">&#8883;</span></b></button>	</div>
<!-- Floating Buttons Code Ends Here -->


<script>
// Example usage: generate month and year from April 2023 till now
generateMonthYearFromDate( new Date("April 2023") );
</script>