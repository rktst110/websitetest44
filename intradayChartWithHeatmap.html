
<!-- Importing Firebase SDK Starts Here-->
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
 <!-- Importing Firebase SDK Ends Here-->
 
 <!-- Importing JS files for charts of CanvaJs & HighCharts Starts Here-->
<script src="https://cdn.canvasjs.com/canvasjs.stock.min.js"></script>
<script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/heatmap.js"></script>
<script src="https://code.highcharts.com/modules/treemap.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
 <!-- Importing JS files for charts of CanvaJs & HighCharts Ends Here-->
 

  <script src="functions/commonFunctions.js"></script>
  <script src="functions/tableSortingFunctons.js"></script>
 <script src="functions/importFiles.js"></script>
 <script src="functions/firebase.js"></script>
 <script src="functions/firebaseFunctions.js"></script>

 <div id="importedContent"></div>
 
 <title>Intraday Chart + HeatMap</title>
 
 

<style>

thead {
  position: sticky;
  top: 0;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background-color: #555;
  color: white; /* Set the text color to white */
}

* {
  box-sizing: border-box;
}

/* Create two unequal columns that floats next to each other */
.column {
  float: left;
  padding: 0.5px;
  height: 520px; /* Should be removed. Only for demonstration */
}

.equityLeft {
  width: 50%;
}

.spurtsRight {
  width: 50%;
}

.left {
  width: 25%;
}

.right {
  width: 75%;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

@media screen and (max-width: 800px) {
  .column {
    width: 100%;
  }
}
</style>
<style> *, *:before, *:after {box-sizing: border-box;}body {font-family: -apple-system, ".SFNSText-Regular", "Helvetica Neue", "Roboto", "Segoe UI", sans-serif;}.toggle {cursor: pointer;display: inline-block;}.toggle-switch {display: inline-block;background: #ccc;border-radius: 16px;width: 58px;height: 32px;position: relative;vertical-align: middle;transition: background 0.25s;}.toggle-switch:before, .toggle-switch:after {content: "";}.toggle-switch:before {display: block;background: linear-gradient(to bottom, #fff 0%, #eee 100%);border-radius: 50%;box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.25);width: 24px;height: 24px;position: absolute;top: 4px;left: 4px;transition: left 0.25s;}.toggle:hover .toggle-switch:before {background: linear-gradient(to bottom, #fff 0%, #fff 100%);box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.5);}.toggle-checkbox:checked + .toggle-switch {background: #56c080;}.toggle-checkbox:checked + .toggle-switch:before {left: 30px;}.toggle-checkbox {position: absolute;visibility: hidden;}.toggle-label {margin-left: 5px;position: relative;top: 2px;} </style>
		

 <label>Month Year:</label>
<select id="monthYear" onchange="getFirestoreData()">
</select>

 <label> | Trading Date:</label>
<select id="tradingDate" onchange="setCommonSelectors()">
</select>


 <label> | Common TimeValues:</label>
<select id="commonTimeValues" onchange="saveSelectedValues();fetchDataForAllSegments()">
</select>

&nbsp; | &nbsp;&nbsp;
<button id="dataRefreshButton" onclick="getFirestoreData('refresh','')">Refresh</button>
&nbsp;&nbsp;<button id="dataRefreshButton" onclick="getFirestoreData('live','')">Live</button>

<hr>

 <label> Chart Symbols:</label>
<!-- <select id="intradayChartSymbols" onchange="Intraday_Chart_OI_Data_Flow_timeValues()"> -->
<select id="chart_index_type_value" onchange="setExpires()">
</select>

&nbsp;&nbsp;Expiry: &nbsp;<select id="intraday_index_expiry_value" aria-labelledby="expiryLbl"  onchange="syncCandlesWithOIData()">         </select> 
&nbsp;&nbsp;TimeFrame  &nbsp;<input id="chartTimeFrame" type="number" min="3" value="3" size="3" onchange="syncCandlesWithOIData()">  			
	
 <span class="toggle-label"> Sync With Time :  </span> <label class="toggle">  <input id="syncWithCommonTime" class="toggle-checkbox" type="checkbox"> <div class="toggle-switch"></div> </label>   

&nbsp; | &nbsp;&nbsp;
 <label> Spurts TimeValues:</label>
<select id="spurtsTimeValues" onchange="getSpurtsEquityData()">
</select>

<!--Content Start From Here-->
 <div id="IntradayChartWithOIDataFlowContainer" style="height: 500px; width: 99%; margin: 0px auto;"></div>

   <br>   <br>
   <center> HeatMap Sectors: &nbsp;<select id="heatMapSectorSelector" aria-labelledby="expiryLbl" onchange="showHeatMapChart()"> <option value="">Select</option> </select></center>  <div id="heatMapContainer" style=" height:500px; width: auto; margin: 0 auto;"></div>

<div class="row">
  <div class="column left" style="background-color:#aaa;">
  

   <br>
   </div>
  <div class="column right" style="background-color:#bbb;">
  
  </div>
</div>

<br><br>





<div class="row">
  <div class="column equityLeft" style="background-color:#aaa;">
    <div class="spaceBetweenTables">  	<div id="equityDataTableContainer"></div> </div>
  </div>
  <div class="column spurtsRight" style="background-color:#bbb;">
    <div class="spaceBetweenTables">  	<div id="spurtsDataTableContainer"></div> </div>
  </div>
</div>


<!--<div class="tableRow"> <center> Spurts Time: &nbsp;<select id="spurts_time_for_both" aria-labelledby="expiryLbl" onchange="adjust_equity_spurts_timeValues()"> <option value="">Select</option> </select> &nbsp; &nbsp;  | &nbsp; &nbsp; No. of Comparison Stocks : &nbsp; <input id="noOfComparisonStocks" type="number" value="30" size="3"> <button onclick="compareEquitySpurtsStocks(\'compareEquityWithSpurts\')">Cmp EquitySpurts</button> <button onclick="compareEquitySpurtsStocks(\'compareSpurtsWithEquity\')">Cmp SpurtsEquity</button>   </center> <br> <div class="tableColumn" style="background-color: ;border: 2px solid #4b4d4e;"> <div class="tableRow"> <center> Equity Time: &nbsp;<select id="only_equity_time" aria-labelledby="expiryLbl" onchange="show_only_equity_Data()"> <option value="">Select</option> </select> </center>  <div id="equityDataTableContainer"></div> </div> </div> <div class="tableColumn" style="border: 2px solid #4b4d4e;"> <div class="tableRow"> <center> Spurts Time: &nbsp;<select id="only_spurts_time" aria-labelledby="expiryLbl" onchange="show_only_Spurts_Data()"> <option value="">Select</option> </select> </center>  <div id="spurtsDataTableContainer"></div> </div> </div> -->


<br><br><br><br><br><br>
<!--Content Ends Here-->


<script>
function fetchDataForAllSegments()
{
//setIndicesSelectorTimeValues( "syncWithCommonTime" );
setSpurtsSelectorTimeValues( "syncWithCommonTime" )
setIntradayChartSelectorValues()

}
</script>


<!-- Indices Code Starts Here -->
<script>

function setIndicesSelectorTimeValues( passedValue )
{
	var tradingDate = document.getElementById('tradingDate').value
	var timeValuesArray = firestoreIndexObj[ tradingDate ]['Index']['index_performace']
	var selectElementRef = document.getElementById("indicesTimeValues");
	
	handleTimeValues( passedValue, timeValuesArray, selectElementRef, getIndicesData )
}

async function getIndicesData( passedValue )
{
	var selectedMonthYear = document.getElementById('monthYear').value
	var selectedTradingDate = document.getElementById('tradingDate').value
	var selectedIndicesTimeValues = document.getElementById('indicesTimeValues').value
	
	var docPath = '/'+selectedMonthYear+'/'+selectedTradingDate+'/index_performace/'+selectedIndicesTimeValues
	//await fetchFirebaseDocData( docPath, showIndicesPerformanceChart )
	var dataObj = await fetchFirebaseDocData( docPath )
	showIndicesPerformanceChart ( JSON.parse( dataObj['data'] ) )

}

async function showIndicesPerformanceChart ( returnedDataObj )
{
	var selectedIndicesTimeValues = document.getElementById('indicesTimeValues').value
	//var selectedValue = document.getElementById("indices_performance_time").value;
		
	//var indicesPerformanceObject = mainOIDataObject['index_performace'][selectedValue]
	var indicesPerformanceObject = returnedDataObj ['data']
		
	var dataPointsArray=[]
	var dataPointsArrayAdvances=[]
	var dataPointsArrayDeclines=[]
	var dataPointsArrayUnchanged=[]
	var dataPointsArrayPChangeAddition=[]
	
	var tempObj={}
	for (var symbol in indicesPerformanceObject) {
		//if(symbol !='INDIA VIX' && symbol !='NIFTY FINSRV25 50' && symbol !='NIFTY HEALTHCARE' )
		if(symbol !='INDIA VIX' && symbol !='NIFTY FINSRV25 50' )
		{
		tempObj[symbol]=indicesPerformanceObject[symbol]['percentChange']
		}
	}
	
// tempObj is sorted by this code
//Object.keys(tempObj).sort((a,b) => tempObj[a]-tempObj[b]).forEach((symbol) => { 	// ascending sort
Object.keys(tempObj).sort((a,b) => tempObj[a]-tempObj[b]).forEach((symbol) => {  	//  descending sort
var temp={}
if(symbol !='NIFTY 50' && symbol !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=symbol.replace(/NIFTY /g,'')
}
else{
	temp["label"]=symbol
}
	
		//temp["y"]=tempObj[symbol]; 
		temp["y"]= Math.abs( tempObj[symbol] ); 
		if(tempObj[symbol]<0) 
		{
			temp["color"]="#cd5652"
		}
		else if(tempObj[symbol]>0) 
		{
			temp["color"]="#3a7dd4"
		}
		else if(tempObj[symbol]==0) 
		{
			temp["color"]="black"
		}
		
		dataPointsArray.push(temp)
	});
	
/*
Object.keys(tempObj).sort((a,b) => tempObj[b]-tempObj[a]).forEach((symbol) => {  	//  descending sort
var temp={}
var sectorName = symbol.replace(/_/g,' ')
if(sectorName !='NIFTY 50' && sectorName !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=sectorName.replace(/NIFTY /g,'')
}
else{
	temp["label"]=sectorName
}
	
		temp["y"]=indicesPerformanceObject[symbol][9]; 
		temp["color"]="#089981"
			
		dataPointsArrayAdvances.push(temp)
		//console.log(symbol, preMarketSectorObj[symbol]["advances"])
	});
	
Object.keys(tempObj).sort((a,b) => tempObj[b]-tempObj[a]).forEach((symbol) => {  	//  descending sort
var temp={}
var sectorName = symbol.replace(/_/g,' ')
if(sectorName !='NIFTY 50' && sectorName !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=sectorName.replace(/NIFTY /g,'')
}
else{
	temp["label"]=sectorName
}
	
		temp["y"]=indicesPerformanceObject[symbol][10]; 
		temp["color"]="#cd5652"
		
	
		
		dataPointsArrayDeclines.push(temp)
		
	});	
	
Object.keys(tempObj).sort((a,b) => tempObj[b]-tempObj[a]).forEach((symbol) => {  	//  descending sort
var temp={}
var sectorName = symbol.replace(/_/g,' ')
if(sectorName !='NIFTY 50' && sectorName !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=sectorName.replace(/NIFTY /g,'')
}
else{
	temp["label"]=sectorName
}
	
		temp["y"]=indicesPerformanceObject[symbol][11]; 
	
		temp["color"]="#cbba4d"
		
		
		dataPointsArrayUnchanged.push(temp)
	});
	
	*/
// this section is for plotting indices chart for simple perchange change of single column bar
var chart = new CanvasJS.Chart("IndicesPerformanceChart", {
	animationEnabled: true,
	theme: "dark2", // "light1", "light2", "dark1", "dark2"
	title: {
		//text: "GDP Growth Rate - 2016"
	},
	subtitles: [{
			//text: "Subtitle 1"
		  },{
			text:  returnedDataObj['timestamp'].split(' ')[0] +' | '+ selectedIndicesTimeValues +' | '+returnedDataObj['timestamp'].split(' ')[1],
			//verticalAlign: "top",

			 //horizontalAlign: "right",
	
			 //fontSize: 15,
			 fontSize: 13,
			//dockInsidePlotArea: true
			dockInsidePlotArea: false
	}],
	
	toolTip: {
			//fontSize: 19,
			fontSize: 15,
	},
	axisY: {
		//title: "Growth Rate (in %)",
		//includeZero: true,
		//suffix: "%",
		gridThickness: 0.03,
		//labelFontSize: 18,
		labelFontSize: 0, // bottom size for change%
		 tickLength: 0,
		 
	},
	axisX: {
		interval: 1,
		//title: "Countries"
		includeZero: true,
		 //labelFontSize: 17,
		 labelFontSize: 11, // vertical axis size for text
		 //labelFontWeight: "bold",
		  lineThickness: 0.5,
         lineColor: "#ccc",
		 tickColor: "#555",
		 tickLength: 0,
		
		 
	},
	dataPointWidth: 12,
	data: [{
		//indexLabel: "{y}",
		//indexLabelFontSize: 18,
		click: onClick,
		//type: "column",
		type: "bar",
		indexLabelPlacement: "auto",
			indexLabel: "{y}",
			indexLabelFontSize: 11,
			indexLabelFontColor: "#ddd",
		yValueFormatString: "#,##0.0#\"%\"",
		dataPoints:dataPointsArray
	}]
});


//console.log("dataPointsArray",dataPointsArray)
chart.render();
//chart2.render();

} // showIndicesPerformanceChart ENDS HERE




function onClick(e) {

		var label=e.dataPoint.label
		var labelToScroll;
		{
			if( label=='NIFTY 50' || label=='NIFTY BANK')
			{
				labelToScroll = label.replace(/ /g, '_')
				document.getElementById("heatMapSectorSelector").value = labelToScroll ;
				showHeatMapChart();
				document.getElementById("heatMapSectorSelector").scrollIntoView();
			}
			else
			{
				labelToScroll = 'NIFTY_'+label.replace(/ /g, '_')
				document.getElementById("heatMapSectorSelector").value = labelToScroll ;
				showHeatMapChart();
				document.getElementById("heatMapSectorSelector").scrollIntoView();
			}
		}

		
}


</script>
<!-- Indices Code Ends Here -->



<!-- Spurts-Equity Code Starts Here -->

<style>    .spaceBetweenTables { border: 2px solid #4b4d4e;height: 518px;overflow-y: scroll;background-color: #32373a; }     .greenHeaderClass{   color: #ffffff;   background: #27ae60;   } .blueHeaderClass{   color: #ffffff;   background: #3a7dd4;    }  caption {	white-space: nowrap;  text-align: center; color: #ffffff; height: px; padding-top: 0rem; padding-bottom: 0rem;	}	</style>


<script>
var dataObjectForHeatChart={}
var sectorStockNamesObj = {}
var allBanksStocksObj ={}

function setSpurtsSelectorTimeValues( passedValue )
{
	var tradingDate = document.getElementById('tradingDate').value
	var timeValuesArray = firestoreIndexObj[ tradingDate ]['Index']['spurts_in_open_interest_by_underlyings']
	var selectElementRef = document.getElementById("spurtsTimeValues");
	
	handleTimeValues( passedValue, timeValuesArray, selectElementRef, getSpurtsEquityData )
}


async function getSpurtsEquityData( passedValue )
{
	var tradingDate = document.getElementById('tradingDate').value
	var selectedMonthYear = document.getElementById('monthYear').value
	var selectedTradingDate = document.getElementById('tradingDate').value
	
	var selectedSpurtsTimeRef = document.getElementById('spurtsTimeValues')
	var selectedSpurtsTimeValue = selectedSpurtsTimeRef.value

	var docPathForSpurts = '/'+selectedMonthYear+'/'+selectedTradingDate+'/spurts_in_open_interest_by_underlyings/'+selectedSpurtsTimeValue
	var spurtsDataObj = await fetchFirebaseDocData( docPathForSpurts )
	
	//console.log( "spurtsDataObj",JSON.parse( spurtsDataObj['data'] ) )
	//console.log( "spurtsDataObjPrevious",JSON.parse( spurtsDataObjPrevious['data'] ) )
	//showIndicesPerformanceChart ( JSON.parse( dataObj['data'] ) )
	
	
	var equityTimeValuesArray = firestoreIndexObj[ tradingDate ]['Index']['equity_market']['FnO']
	var equitySyncedTimeValue = syncTimeValues( equityTimeValuesArray, selectedSpurtsTimeValue )
	var docPathForEquity = '/'+selectedMonthYear+'/'+selectedTradingDate+'/equity_market/FnO/'+equitySyncedTimeValue[0]+'/'+equitySyncedTimeValue[0]
	
	//console.log( "docPathForEquity", docPathForEquity )
	var equityDataObj = await fetchFirebaseDocData( docPathForEquity )
	console.log( "equityDataObj",JSON.parse( equityDataObj['data'] ) )

	var docPathForDeliveryData = '/'+selectedMonthYear+'/'+selectedTradingDate+'/delivery_data/delivery_data'
	var deliveryDataObj = await fetchDeliveryDataDocData( docPathForDeliveryData )
	
	//console.log( "deliveryDataObj",JSON.parse( deliveryDataObj['data'] ) )
	
	
	var collectioPath = '/'+selectedMonthYear+'/'+selectedTradingDate+'/sector_stockNames/'
	sectorStockNamesObj = await fetchSectorStockNamesCollectionData( collectioPath )
	
	await show_only_equity_Data( selectedSpurtsTimeValue, selectedTradingDate, JSON.parse( equityDataObj['data'] ), JSON.parse( spurtsDataObj['data'] ) , JSON.parse( deliveryDataObj['data'] ) )
//	await show_only_Spurts_Data( selectedSpurtsTimeValue, selectedTradingDate, JSON.parse( equityDataObj['data'] ), JSON.parse( spurtsDataObj['data'] ) , JSON.parse( deliveryDataObj['data'] ) )
	
	addEventListnerInTables()
}

async function show_only_equity_Data( selectedSpurtsTimeValue, selectedTradingDate, equityDataObj, spurtsDataObj, deliveryDataObj )
{
	 document.getElementById('equityDataTableContainer').innerHTML = "";
	
	var selectedValue = selectedSpurtsTimeValue
	//var previousTime=selectedValue.options[selectedValue.selectedIndex - 1] 
	
	var niftyTotalMarketObject = equityDataObj['data']
	var spurtsInOIUnderlyingsObject = spurtsDataObj['data']

//console.log( selectedSpurtsTimeValue, selectedSpurtsTimeValuePrevious, equityDataObj, equityDataObjPrevious, spurtsDataObj, spurtsDataObjPrevious  )

		var tempObj = {};

	
	  var onlyEquityTableStr = ' <div class=""> <div class="spaceBetweenTablesSpurtsEquity"> <table id="onlyEquityTableStr"> <caption style="caption-side:top"> Intraday Hike | '+selectedTradingDate+' | '+selectedValue+'</caption> <thead> <tr class="tableRowClass">'
	  +'<th>Symbol</th>'
	  +' <th>Chg%</th>'
	   +' <th>LTP</th>'
	  +' <th>T.O.</th>'
	 +' <th>Money</th>'
	  +' <th>20DAV</th>'
	  +' </tr> </thead> <tbody>'

		for (var S=0; S<spurtsInOIUnderlyingsObject.length ;S++ ) { // loop for accessing all stocks of 754 stocks
		var Symbol=spurtsInOIUnderlyingsObject[S]['symbol']
		//for (var Symbol in niftyTotalMarketObject ) { // loop for accessing all stocks of 754 stocks
		if( Symbol.includes('NIFTY')==false )
		{
		var symbolArray = niftyTotalMarketObject[Symbol] //for short-handing
        var spurtsSymbolArray = spurtsInOIUnderlyingsObject[S] //for short-handing
	
	var SpurtValvsOI = spurtsSymbolArray["total"] / spurtsSymbolArray["latestOI"]
	var average20DaysValue = deliveryDataObj["Symbols"][Symbol]["calculatedData"]["averageValues"]["twentyDays"]
	var EqtyValvs20DAyVal = ( (symbolArray["totalTradedValue"] ) / average20DaysValue)
	
	var WFactor =( EqtyValvs20DAyVal + SpurtValvsOI ).toFixed(2)
	var twentyDAV =( symbolArray["totalTradedValue"]  / average20DaysValue).toFixed(2)
	 
	  var rankForHeatMap = WFactor
	  
		//this block of code is for sectors heatMap chart. (START)
		//this block adds stocks in a object with few values. this code was written on 7-Jan-2023
		{
			//dataObjectForHeatChart["selectedTime"] =selectedValue.value
			dataObjectForHeatChart["selectedTime"] =selectedValue
			dataObjectForHeatChart["selectedTradingDate"] =selectedTradingDate
		   var colorValue;
		   var dataLabelFontColor="white";
		   
		if(symbolArray["pChange"]>=0)
	   {
		   if( symbolArray["pChange"]>=0 && symbolArray["pChange"]<=0.5)
		   {
			   colorValue = '#7cb67e' 
			  // dataLabelFontColor="black"
		   }
		   else if( symbolArray["pChange"]>0.5 && symbolArray["pChange"]<=1)
		   {
			   colorValue = '#6cac6e'
		   } 
		   else if( symbolArray["pChange"]>1 && symbolArray["pChange"]<=2)
		   {
			    colorValue = '#5ca35e'
		   }
		   else if( symbolArray["pChange"]>2)
		   {
			   colorValue = '#539355'
		   }
			   
		  
		   dataObjectForHeatChart[Symbol] ={
			  parent: 'Green',
			 name: Symbol,
			 pChange:symbolArray["pChange"],
			 value: Number(rankForHeatMap),
			 //colorValue: Number(symbolArray["pChange"])
			 color: colorValue,
			 
			 dataLabels: {
				 shadow: false,
				 color: dataLabelFontColor //data label font color
				 //format: '{name pChange} %'
			 }
		 }
		   
		 
	   }
	   else
	   {
		   if( symbolArray["pChange"]>=-0.5 && symbolArray["pChange"]<0)
		   {
			   colorValue = '#d4777a'
			   //dataLabelFontColor="black"
		   }
		   else if( symbolArray["pChange"]>-1 && symbolArray["pChange"]<=-0.5)
		   {
			   colorValue = '#ce6467'
		   }
		   else if( symbolArray["pChange"]>-2 && symbolArray["pChange"]<=-1)
		   {
			   colorValue = '#ca575a'
		   }
		   else if( symbolArray["pChange"]>-2)
		   {
			   colorValue = '#c85155'
		   }
			   
			 dataObjectForHeatChart[Symbol] ={
			  parent: 'Red',
			 name: Symbol,
			 pChange:symbolArray["pChange"],
			 value: Number(rankForHeatMap),
			 //colorValue: Number(symbolArray["pChange"])
			 color: colorValue,
			 
			 dataLabels: {
				  shadow: false,
				 color: dataLabelFontColor, //data label font color
				 //format: '{name pChange} %'
			 }
		 }
		  
		  
	   }
		
		}	   	//this block of code is for sectors heatMap chart. (END)
		  
		  
		  
		{
			onlyEquityTableStr +='<tr class="item"><td>'
			 +Symbol
			 +'</td><td>'
			+ symbolArray['pChange']  //pchange
			 +'</td><td>'
			 +symbolArray['lastPrice']  //lastPrice
			 +'</td><td>'
			 +( symbolArray['totalTradedValue'] / 1000000).toFixed(0)  //(symbolArray[8] / 10000000).toFixed(2) //totalTradedValue
		 +'</td><td>'
		 + WFactor
		+'</td><td>'
		+ twentyDAV
		+'</td></tr>'
			
		
		}
	}
		} //for Loop ENDS HERE
		
		onlyEquityTableStr +=' </tbody> </table>    </div>  </div>'
		
	//document.getElementById('equityDataTableContainer').innerHTML = onlyEquityTableStr
	 //addEventListnerInTables()
	 add_Sectors_In_HeatMapSelector( )
}	//	show_volume_value_spike_Data() Function ENDS HERE

async function show_only_Spurts_Data( selectedSpurtsTimeValue, selectedTradingDate, equityDataObj, spurtsDataObj, deliveryDataObj )
{
	 document.getElementById('spurtsDataTableContainer').innerHTML = "";

	var onlySpurtsSelectedTime = selectedSpurtsTimeValue
	var spurtsInOIUnderlyingsObject = spurtsDataObj['data']
	var niftyTotalMarketObject = equityDataObj ['data']


	//Object.fromEntries( Object.entries(FnOList).sort( (a,b) => b[1] - a[1] ) )   // for sorting object ascending
	//Object.fromEntries( Object.entries(FnOList).sort( (a,b) => a[1] - b[1] ) )   // for sorting object descending

	var tablesStr =  '<div class=""><div class="spaceBetweenTablesSpurtsEquity"><table id="onlySpurtsOIUnderlyingsTableStr"><caption style="caption-side:top">High Powered | '+selectedTradingDate+' | '+onlySpurtsSelectedTime+'</caption><thead class="tableRowClass">   <tr>      <th>Symbol</th> <th>EQ Chng(%)</th> <th>EQ TO</th>  <th>TO/OI</th>      <th>Chng (%)</th>      <th>OI</th>   <th>Vol</th>       </tr></thead><tbody>'
		
	for( var F=0; F< Object.keys( spurtsInOIUnderlyingsObject ).length ; F++ ) {

	var symbol = spurtsInOIUnderlyingsObject[F]["symbol"]
	
		if( symbol.includes('NIFTY')==false ){

		tablesStr +='<tr class="item"><td>'
		+ symbol
		+'</td><td>'
		+ niftyTotalMarketObject[symbol]["pChange"] // equity/NiftyTotalMarket pchange
		+'</td><td>'
		+( niftyTotalMarketObject[symbol]["totalTradedValue"] / 1000000).toFixed(0) // equity/NiftyTotalMarket totalTradedValue
		+'</td><td>'
		//+ spurtsInOIUnderlyingsObject[symbol][8] // underlyingValue
		+ (spurtsInOIUnderlyingsObject[F]["total"] / spurtsInOIUnderlyingsObject[F]["latestOI"] ).toFixed(2)// underlyingValue
		+'</td><td>'
	 	  + spurtsInOIUnderlyingsObject[F]["avgInOI"]  //"avgInOI/perChangeInOI
		+'</td><td>'
		//+ spurtsInOIUnderlyingsObject[symbol][4] //volume
		+ spurtsInOIUnderlyingsObject[F]["latestOI"] //OI
		+'</td><td>'
		+ spurtsInOIUnderlyingsObject[F]["volume"] //Volume
		//+'</td><td>'
		//+ (1/(spurtsInOIUnderlyingsObject[F]["latestOI"] / spurtsInOIUnderlyingsObject[F]["volume"])).toFixed(2) //OI/Volume
		//+'</td><td>'
		//+ returnedCandlestickPatternsStr //Candlestick Patterns
		+'</td></tr>'
			
		
	}
	}
	tablesStr +=' </tbody> </table>    </div>  </div>'


	
	 document.getElementById('spurtsDataTableContainer').innerHTML = tablesStr;
	 //document.getElementById('allSpurtsUnderlyingsColumnsContainer').innerHTML += tablesStrForNegative;
	 
	// await addEventListnerInTables()
}	//	show_spurts_in_oi_underlyings_Data() Function ENDS HERE



function add_Sectors_In_HeatMapSelector( )
{
	//console.log( "sectorStockNamesObj", sectorStockNamesObj)
	
	if( sectorStockNamesObj !=undefined)
	{
	if( document.getElementById("heatMapSectorSelector").getElementsByTagName('option').length <=1 )
	{
	document.getElementById("heatMapSectorSelector").innerHTML = "";
	
	var option = document.createElement("option");
	option.value = "ALL BANKS";
	option.text = "ALL BANKS";
	document.getElementById("heatMapSectorSelector").add(option);
	
	
	for ( var sectorName in sectorStockNamesObj ) {
		
		if( sectorName != 'Template' )
		{
		var option = document.createElement("option");
		option.value = sectorName;
		option.text = sectorName;
		document.getElementById("heatMapSectorSelector").add(option);
		}
	}
	document.getElementById('heatMapSectorSelector').value=document.getElementById('heatMapSectorSelector').getElementsByTagName('option')[2].value
	}
	
	//showHeatMapChart(sectorStockNamesObj)
	showHeatMapChart()
	}
	
} // add_Sectors_In_HeatMapSelector() ENDS HERE

async function showHeatMapChart( )
{
	await setHighChartsDarkTheme()
	var sectorDataArrayForHeatChart=[{
      id: 'Green',
      //name: 'Green',
      color: "#EC2500"
    }, {
      id: 'Red',
      //name: 'Red',
      color: "#ECE100"
    }]
	
	var heatMapSectorSelected = document.getElementById("heatMapSectorSelector").value
	var sectorStockArray;
	if( heatMapSectorSelected=='ALL BANKS' )
	{
		
		for( var sector in sectorStockNamesObj )
		{
			if( sector.includes('BANK')==true )
			{
				var sectorStockArray = sectorStockNamesObj [sector]
				for( var s=0;s<sectorStockArray.length;s++)
				{
					var Symbol = sectorStockArray [s]
					allBanksStocksObj [Symbol] = 1
				}
				
			}
		}
		
		sectorStockArray = Object.keys(allBanksStocksObj)
	}
	else {
	sectorStockArray = sectorStockNamesObj [heatMapSectorSelected] 
	}
	for( var s=0;s<sectorStockArray.length;s++)
	{
		var Symbol = sectorStockArray [s]
		//console.log(Symbol)
		if( dataObjectForHeatChart[Symbol] !=undefined )
		{
			sectorDataArrayForHeatChart.push( dataObjectForHeatChart[Symbol] )
		}
	}
	//console.log("sectorDataArrayForHeatChart", sectorDataArrayForHeatChart)
	
	
var H = Highcharts
H.addEvent(H.Legend, 'afterGetAllItems', function(e) {
  e.allItems.splice(2, 6);
});

H.chart('heatMapContainer', {
  colorAxis: {
      stops: [
       
	  [0, '#ff0000'],//red
      [0.5, '#fff'], // white
      [1, '#02ff00']//green
	  
    ],
  },
  legend: {
      enabled: false
    },
  series: [{
	animation: false,
	borderWidth: 0.25,
    //borderColor: '#fff',
    borderColor: '#4b4b4c',
    colorAxis: 0,
    legendType: 'point',
    showInLegend: false,
    type: "treemap",
    layoutAlgorithm: 'squarified',
    alternateStartingDirection: true,
    levels: [{
      level: 1,
      layoutAlgorithm: 'sliceAndDice',
      dataLabels: {
        enabled: false,
        align: 'left',
        verticalAlign: 'top',
        style: {
          fontSize: '15px',
          fontWeight: 'bold'
        }
      }
    }],
    data: sectorDataArrayForHeatChart,
	
  dataLabels: {
		enabled: true,
                format: '{point.name} <br> {point.value}',
			 },
			 
			  events: {
                    click: function (event) {
                        //console.log(event.point.name);
						copyHeatMapList( heatMapSectorSelected, event.point.parent )
                    }
                }
  }],
  tooltip: {
            //headerFormat: 'Temperature<br/>',
            pointFormat: '{point.name} <br> pChange: {point.pChange} <br> Rank: {point.value}'
        },
	
  title: {
    //text: heatMapSectorSelected +' | '+ dataObjectForHeatChart["selectedTime"] +' | '+ mainOIDataObject['Date'],
    text: heatMapSectorSelected +' | '+ dataObjectForHeatChart["selectedTradingDate"] +' | '+ dataObjectForHeatChart["selectedTime"],
	   style: {
                    //color: 'red',
                    fontSize:'15px'
                }
  }
});

}

function setHighChartsDarkTheme()
{

	Highcharts.theme = {
    colors: ['#2b908f', '#90ee7e', '#f45b5b', '#7798BF', '#aaeeee', '#ff0066',
        '#eeaaee', '#55BF3B', '#DF5353', '#7798BF', '#aaeeee'],
    chart: {
        backgroundColor: {
            linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
            stops: [
                [0, '#2a2a2b'],
                [1, '#3e3e40']
            ]
        },
        style: {
     
        },
        plotBorderColor: '#606063'
    },
    title: {
        style: {
            color: '#E0E0E3',
            textTransform: 'uppercase',
            fontSize: '20px'
        }
    },
    subtitle: {
        style: {
            color: '#E0E0E3',
            textTransform: 'uppercase'
        }
    },
    xAxis: {
        gridLineColor: '#707073',
        labels: {
            style: {
                color: '#E0E0E3'
            }
        },
        lineColor: '#707073',
        minorGridLineColor: '#505053',
        tickColor: '#707073',
        title: {
            style: {
                color: '#A0A0A3'
            }
        }
    },
    yAxis: {
        gridLineColor: '#707073',
        labels: {
            style: {
                color: '#E0E0E3'
            }
        },
        lineColor: '#707073',
        minorGridLineColor: '#505053',
        tickColor: '#707073',
        tickWidth: 1,
        title: {
            style: {
                color: '#A0A0A3'
            }
        }
    },
    tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.85)',
        style: {
            color: '#F0F0F0'
        }
    },
    plotOptions: {
        series: {
            dataLabels: {
                color: '#F0F0F3',
                style: {
                    fontSize: '12px'
                }
            },
            marker: {
                lineColor: '#333'
            }
        },
        boxplot: {
            fillColor: '#505053'
        },
        candlestick: {
          
        },
        errorbar: {
            
        }
    },
    legend: {
        backgroundColor: 'rgba(0, 0, 0, 0.5)',
        itemStyle: {
            color: '#E0E0E3'
        },
        itemHoverStyle: {
            color: '#FFF'
        },
        itemHiddenStyle: {
            color: '#606063'
        },
        title: {
            style: {
                color: '#C0C0C0'
            }
        }
    },
    credits: {
        style: {
            color: '#666'
        }
    },
    labels: {
        style: {
            color: '#707073'
        }
    },
    drilldown: {
        activeAxisLabelStyle: {
            color: '#F0F0F3'
        },
        activeDataLabelStyle: {
            color: '#F0F0F3'
        }
    },
    navigation: {
        buttonOptions: {
            symbolStroke: '#DDDDDD',
            theme: {
                fill: '#505053'
            }
        }
    },
    // scroll charts
    rangeSelector: {
        buttonTheme: {
            fill: '#505053',
            stroke: '#000000',
            style: {
              
            },
            states: {
                hover: {
                    fill: '#707073',
                    stroke: '#000000',
                    style: {
                      
                    }
                },
                select: {
                    fill: '#000003',
                    stroke: '#000000',
                    style: {
                        
                    }
                }
            }
        },
        inputBoxBorderColor: '#505053',
        inputStyle: {
            backgroundColor: '#333',
            color: 'silver'
        },
        labelStyle: {
            color: 'silver'
        }
    },
    navigator: {
        handles: {
            backgroundColor: '#666',
            borderColor: '#AAA'
        },
        outlineColor: '#CCC',
        maskFill: 'rgba(255,255,255,0.1)',
        series: {
            color: '#7798BF',
            lineColor: '#A6C7ED'
        },
        xAxis: {
            gridLineColor: '#505053'
        }
    },
    scrollbar: {
        barBackgroundColor: '#808083',
        barBorderColor: '#808083',
        buttonArrowColor: '#CCC',
        buttonBackgroundColor: '#606063',
        buttonBorderColor: '#606063',
        rifleColor: '#FFF',
        trackBackgroundColor: '#404043',
        trackBorderColor: '#404043'
    }
};
	// Apply the theme
	Highcharts.setOptions(Highcharts.theme);

}

function copyHeatMapList( heatMapSectorSelected, greenOrRed )
{
	var symbolObject ={}
	var sectorStockArray;
	if( heatMapSectorSelected=='ALL BANKS' )
	{
		sectorStockArray = Object.keys(allBanksStocksObj)
	}
	else {
	sectorStockArray = sectorStockNamesObj[heatMapSectorSelected]
	}
	
	for( var s=0;s<sectorStockArray.length;s++)
	{
		var Symbol = sectorStockArray [s]
		//console.log(Symbol)
		if( dataObjectForHeatChart[Symbol] !=undefined )
		{
			if( dataObjectForHeatChart[Symbol]["parent"]==greenOrRed )
				symbolObject[Symbol] = dataObjectForHeatChart[Symbol]["value"] //symbol's rank
		}
	}
	
	var stockNames=''
	stockNames= ( 'NSE:'+dataObjectForHeatChart["selectedTime"] +'_'+ heatMapSectorSelected+',' ).replace(/ /g,'_')
	
	Object.keys(symbolObject).sort((a,b) => symbolObject[b]-symbolObject[a]).forEach((symbol) => {    	//  descending sort
		stockNames +='NSE:'+symbol.replace(/-/g,'_').replace(/&amp;/g,'_').replace(/&/g,'_') +','
	});

	
	
	navigator.clipboard.writeText(stockNames);
}

</script>
<!-- Spurts-Equity Code Ends Here -->



<script>

// OI Flow with OHLC Candlesticks code (STARTS HERE)

async function setIntradayChartSelectorValues( passedValue )
{
	var tradingDate = document.getElementById('tradingDate').value
	var optionChainObj = firestoreIndexObj[ tradingDate ]['Index']['option_chain_data']
	var selectElementRef = document.getElementById("chart_index_type_value");
	
	//selectElementRef.innerHTML = '<option>Select</option>'
	selectElementRef.innerHTML = ''
	for(var symbol in optionChainObj )
	{
	 var optionElement = document.createElement("option");
    optionElement.text = symbol;
    selectElementRef.add(optionElement);
	}
	
	document.getElementById("chartTimeFrame").addEventListener("keydown", function (e) {
    if (e.code === "Enter") {  //checks whether the pressed key is "Enter"
        syncCandlesWithOIData();
    }
	});
	//handleTimeValues( passedValue, timeValuesArray, selectElementRef, getIndicesData )
	
	 setExpires()
	 
	 
}

async function setExpires()
{
	var tradingDate = document.getElementById('tradingDate').value
	var selectedSymbol = document.getElementById("chart_index_type_value").value;
	var optionChainExpiriesArray= firestoreIndexObj[ tradingDate ]['Index']['option_chain_data'][selectedSymbol]['expiryDates']
	var selectElementRef = document.getElementById("intraday_index_expiry_value");
	
	selectElementRef.innerHTML = ''
	for( var i=0;i<optionChainExpiriesArray.length;i++ )
	{
	if( optionChainExpiriesArray[i]!="timestamp" )
	{
	 var optionElement = document.createElement("option");
    optionElement.text = optionChainExpiriesArray[i];
    selectElementRef.add(optionElement);
		}
	}

await syncCandlesWithOIData() 

}

async function syncCandlesWithOIData()
{
	var selectedMonthYear = document.getElementById('monthYear').value
	var selectedTradingDate = document.getElementById('tradingDate').value
	var selectedSymbol = document.getElementById("chart_index_type_value").value;
	var selectedExpiry = document.getElementById("intraday_index_expiry_value").value;
	var selectedCommonTimeValue = document.getElementById("commonTimeValues").value;

	var selectedIndexValue = document.getElementById("chart_index_type_value").value
	var selectedExpiryValue = document.getElementById("intraday_index_expiry_value").value
	//var symbolTimeValues = mainOIDataObject['option_chain_data'][selectedIndexValue][ selectedExpiryValue ]
	var chartTimeFrame = document.getElementById("chartTimeFrame").value
	
//var indexTimeValue = Object.keys( symbolTimeValues )

var intradayChartSymbol ;
if( selectedIndexValue=='NIFTY' )
	intradayChartSymbol = 'NIFTY 50'
else if( selectedIndexValue=='BANKNIFTY' )
	intradayChartSymbol = 'NIFTY BANK'
else if( selectedIndexValue=='FINNIFTY' )
	intradayChartSymbol = 'NIFTY FIN SERVICE'




	var docPath = '/'+selectedMonthYear+'/'+selectedTradingDate+'/intraday_chart_data/'+intradayChartSymbol

	//await fetchFirebaseDocData( docPath, showIndicesPerformanceChart )

	//var dataObjFromTime =  JSON.parse( (await fetchFirebaseDocData( docPathFromTime ) ) ['data'] )
	var graphDataObj =   (await fetchFirebaseDocData( docPath ) )
	
//console.log( "graphDataObj", JSON.parse( graphDataObj['data'] ) )
console.log( "graphDataObj",  graphDataObj )

/*
const timestamp = JSON.parse( graphDataObj['data'] )[graphData];
const date = new Date(timestamp).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-');
console.log(date);
*/



//var graphData = mainOIDataObject['intraday_chart_data'][intradayChartSymbol]['graphData']
//var graphDataObj = mainOIDataObject['intraday_chart_data'][intradayChartSymbol]

var candlesObj = await generateCandlestickFromGraphData( JSON.parse( graphDataObj['data'] ), chartTimeFrame, selectedTradingDate, selectedCommonTimeValue )

console.log( "candlesObj", candlesObj )

var timeValuesWithTotalCEPEObj = {}
var indexTimeValue =[]
var totalCEPE_OIDataObj = graphDataObj['totalCEPE_OIData']
for( var timeValue in totalCEPE_OIDataObj ) // timeValue in this format 09:18:00_09:16:15
{
var time = timeValue.split('_')[0] 
indexTimeValue.push( time )
timeValuesWithTotalCEPEObj[ time ] = totalCEPE_OIDataObj[timeValue][selectedExpiryValue]
}

indexTimeValue = indexTimeValue.sort((a, b) => new Date(`1970/01/01 ${a}`) - new Date(`1970/01/01 ${b}`));



//console.log( "indexTimeValue", indexTimeValue )

var dataPointsArray = []
for( var DateTimeMilliseconds in candlesObj )
{
	var candleDataObj = candlesObj [ DateTimeMilliseconds ]

	var candleStartingTime = candleDataObj["candleTimeDuration"].split('-')[0]
	var candleEndingTime = candleDataObj["candleTimeDuration"].split('-')[1]
	
	var result = indexTimeValue.filter(function(item) {
		var arrayElement = item.substr(0, 5) 
	  return arrayElement >= candleStartingTime && arrayElement <= candleEndingTime;
	});
	
	
	
	//console.log( candleStartingTime, candleEndingTime,  result )
	
	
	//candleDataObj["date"] = new Date( Number(DateTimeMilliseconds) ).toUTCString()
	candleDataObj["date"] = Number(DateTimeMilliseconds)
	if( result.length<1 )
	{
	
	candleDataObj["OIData"] = 0
	candleDataObj["OIDataColor"] =  "red"
	}
	else if( result.length<=2 )
	//if( chartTimeFrame<=3 )
	{
		
		var previousTimeValue =	( indexTimeValue.indexOf( result[result.length-1] ) -3 )
		if( indexTimeValue[ previousTimeValue ]==undefined )
			previousTimeValue = indexTimeValue[0]
		else
			previousTimeValue = indexTimeValue[ previousTimeValue ]
		
		//console.log( "previousTimeValue", previousTimeValue )
			//var returnedOIDataObj = await calculate_OI_Data_Change_For_Chart( symbolTimeValues, result[0], result[result.length-1] )
		var returnedOIDataObj = await calculate_OI_Data_Change_For_Chart( timeValuesWithTotalCEPEObj, previousTimeValue, result[result.length-1] )
	
	candleDataObj["OIData"] = returnedOIDataObj ["y"]
	candleDataObj["OIDataColor"] =  returnedOIDataObj ["color"]
	}
	else{
		var returnedOIDataObj = await calculate_OI_Data_Change_For_Chart( timeValuesWithTotalCEPEObj, result[0], result[result.length-1] )
		//var returnedOIDataObj = await calculate_OI_Data_Change_For_Chart( symbolTimeValues, indexTimeValue [0], result[result.length-1] )
	candleDataObj["OIData"] = returnedOIDataObj ["y"]
	candleDataObj["OIDataColor"] =  returnedOIDataObj ["color"]
	}
	
	
	
	dataPointsArray.push( candleDataObj )
	
}

//console.log( dataPointsArray )

await showIntradayChartWithOIFlowData( dataPointsArray, selectedIndexValue, selectedExpiryValue, chartTimeFrame )

await showHeatMapChartWithIntradayChart( selectedIndexValue )


}


async function generateCandlestickFromGraphData( graphDataObj, chartTimeFrame, currentTradingDate, selectedTimeValue )
{
	var graphData = graphDataObj['graphData']

//mainOIDataObject.intraday_chart_data['NIFTY 50']['graphData'][ new Date( "08 Mar 2023 09:15:01 GMT").getTime()+1000 ]
//new Date( "08 Mar 2023 09:15:01 GMT").getTime()

var candleTimeFrame = chartTimeFrame // in minutes

//var DateTimeMilliseconds = new Date( "08 Mar 2023 09:15:00 GMT").getTime()
//var DateTimeMilliseconds = new Date( mainOIDataObject['Date'] +" 09:15:00 GMT").getTime()
var DateTimeMilliseconds = new Date( currentTradingDate +" 09:15:00 GMT").getTime()
//var LastCandleDateTimeMilliseconds = new Date( mainOIDataObject['Date'] +" 15:30:00 GMT").getTime()
var LastCandleDateTimeMilliseconds = new Date( currentTradingDate +" 15:30:00 GMT").getTime()

//var graphData = mainOIDataObject['intraday_chart_data']['NIFTY 50']['graphData']
var lastDateTimeMilliseconds =  Number( Object.keys(graphData)[Object.keys(graphData).length-1] )
//console.log( "lastDateTimeMilliseconds",lastDateTimeMilliseconds )


var indices_performance_time = selectedTimeValue; 

var syncedLastDateTimeMilliseconds; //added on 07-April-2023

if( document.getElementById('syncWithCommonTime').checked==true )
{ //added on 07-April-2023
	//syncedLastDateTimeMilliseconds = new Date( mainOIDataObject['Date'] +" "+indices_performance_time+" GMT").getTime()
	syncedLastDateTimeMilliseconds = new Date( currentTradingDate +" "+indices_performance_time+" GMT").getTime()
}
else

{
	syncedLastDateTimeMilliseconds = lastDateTimeMilliseconds
}

var candleStarting = DateTimeMilliseconds
var candleEnding ;
if( graphData[ candleStarting + ( candleTimeFrame * 60 * 1000 ) ] != undefined )
{
	candleEnding = candleStarting + ( candleTimeFrame * 60 * 1000 )
}
else
{
	candleEnding = lastDateTimeMilliseconds
}


var ohlcCandles = {}

//while( candleEnding<lastDateTimeMilliseconds ) {
while( candleEnding< LastCandleDateTimeMilliseconds ) {
	
	//console.log( new Date(Number(candleStarting)).toUTCString().split(' ')[4], new Date(Number(candleEnding)).toUTCString().split(' ')[4]  )
	var candleStartingToEnding =  new Date(Number(candleStarting)).toUTCString().split(' ')[4] +'-'+ new Date(Number(candleEnding)).toUTCString().split(' ')[4]  
	var candleTimeDuration =  new Date(Number(candleStarting)).toUTCString().split(' ')[4].substr(0,5) +'-'+ new Date(Number(candleEnding)).toUTCString().split(' ')[4].substr(0,5)
	//ohlcCandles[ candleStartingToEnding ] ={}
	ohlcCandles[ candleStarting ] ={}
	if( graphData[ candleStarting ] == undefined || graphData[ candleEnding ] == undefined || candleEnding>syncedLastDateTimeMilliseconds )
	{
		ohlcCandles[ candleStarting ] ={
			"open" : graphDataObj['closePrice'],
			"high" : graphDataObj['closePrice'],
			//"high" : Math.max(...pricesArray),
			"low" : graphDataObj['closePrice'],
			//"low" : Math.min(...pricesArray),
			"close" : graphDataObj['closePrice'],
			//"candleTimeDuration" : candleStartingToEnding
			"candleTimeDuration" : "-"
		}

	}
	else {
		var tempCandleStarting = candleStarting
		var tempCandleEnding = candleEnding
		var pricesArray = []

		var openPrice = graphData[ tempCandleStarting ]
		var highPrice = graphData[ tempCandleStarting ]
		var lowPrice = graphData[ tempCandleStarting ]
		var closePrice = graphData[ tempCandleEnding ]

		var OHLCarray = []

		while(tempCandleStarting<tempCandleEnding) {

			var price = graphData[ tempCandleStarting ]
			if( price > highPrice )
				highPrice = price
			
			if( price < lowPrice )
				lowPrice = price
			
			pricesArray.push( price )
			
		   tempCandleStarting = tempCandleStarting + 1000 ;
		}

		//OHLCarray.push(openPrice); OHLCarray.push(highPrice); OHLCarray.push(lowPrice); OHLCarray.push(closePrice); 

		//OHLCarray
		
		//ohlcCandles[ candleStartingToEnding ] ={
		ohlcCandles[ candleStarting ] ={
			"open" : openPrice,
			"high" : highPrice,
			//"high" : Math.max(...pricesArray),
			"low" : lowPrice,
			//"low" : Math.min(...pricesArray),
			"close" : closePrice,
			//"candleTimeDuration" : candleStartingToEnding
			"candleTimeDuration" : candleTimeDuration
		}
		
	}

	
	
	candleStarting = candleEnding
	candleEnding = candleStarting + ( candleTimeFrame * 60 * 1000 )
	
	
}


//console.log("ohlcCandles",ohlcCandles)

return ohlcCandles;




}


async function calculate_OI_Data_Change_For_Chart( symbolTimeValues, startingTimeValue, endingTimeValue ) 
//this function calculate OI Data Change in each two entries of any stock/index
{
//console.log( "symbolTimeValues",symbolTimeValues )
//console.log( "startingTimeValue",startingTimeValue )
//console.log( "endingTimeValue",endingTimeValue )
var OIChangeObj = {}

var dataPointsArray=[]

var previousTimeValue = startingTimeValue
var previousEntryData ;
var timeValue = endingTimeValue

{
	var temp={}
			
		//var previousSelectedTimeData = symbolTimeValues[previousTimeValue] ['totalCEPE']
		var previousSelectedTimeData = symbolTimeValues[previousTimeValue] 
		//var currentSelectedTimeData = symbolTimeValues[timeValue] ['totalCEPE']
		var currentSelectedTimeData = symbolTimeValues[timeValue]
		
		var callPutSubstraction
		var CallPut

		changeInCall = currentSelectedTimeData["intradayOICEChange"] - previousSelectedTimeData["intradayOICEChange"]
		changeInPut = currentSelectedTimeData["intradayOIPEChange"] - previousSelectedTimeData["intradayOIPEChange"]
		
		//if (changeInCall > changeInPut)
		
		if( changeInCall<=0 && changeInPut>=0 )
		{
			callPutSubstraction = Math.abs(changeInCall) + Math.abs(changeInPut)
		}
		else if( changeInCall>=0 && changeInPut<=0 )
		{
			callPutSubstraction = Math.abs(changeInCall) + Math.abs(changeInPut)
		}
		else if( changeInCall>=0 && changeInPut>=0 )
		{
			if ( Math.abs(changeInCall) > Math.abs(changeInPut) )
			{
				callPutSubstraction = Math.abs(changeInCall) - Math.abs(changeInPut)
			}
			else if ( Math.abs(changeInPut) > Math.abs(changeInCall) )
			{
				callPutSubstraction = Math.abs(changeInPut)-Math.abs(changeInCall)
			}
		}
		else if( changeInCall<=0 && changeInPut<=0 )
		{
			if ( Math.abs(changeInCall) > Math.abs(changeInPut) )
			{
				callPutSubstraction = Math.abs(changeInCall) - Math.abs(changeInPut)
			}
			else if ( Math.abs(changeInPut) > Math.abs(changeInCall) )
			{
				callPutSubstraction = Math.abs(changeInPut)-Math.abs(changeInCall)
			}
		}
			
		
		if ( Math.abs(changeInCall) >= Math.abs(changeInPut) )
		{
			//callPutSubstraction = changeInCall-changeInPut
			//callPutSubstraction = Math.abs(changeInCall)-Math.abs(changeInPut)
			//CallPut = "Call"
			
			OIChangeObj[ previousTimeValue+"-"+timeValue ] = {
			"Call":callPutSubstraction,
			"changeInCall":changeInCall,
			"changeInPut":changeInPut
			}
			
			
			temp["label"]=timeValue
			//temp["x"]=timeValue
			if( changeInCall < 0 ) 
			{ //short covering
				temp["y"]= callPutSubstraction
				temp["color"]="#ACE1D7" // light green color
				//temp["color"]="blue" // light green color
				dataPointsArray.push(temp)
			}
			else if( changeInCall>=0 ) 
			{ // short buildup
				temp["y"]= (- callPutSubstraction )  
				temp["color"]="#cd5652" // red color			
				dataPointsArray.push(temp)
			}
			
			
		}
		else if ( Math.abs(changeInPut) >= Math.abs(changeInCall) )
		{
			//callPutSubstraction = Math.abs(changeInPut)-Math.abs(changeInCall)
			//CallPut = "Put"
			
			OIChangeObj[ previousTimeValue+"-"+timeValue ] = {
			"Put":callPutSubstraction,
			"changeInCall":changeInCall,
			"changeInPut":changeInPut
			}
			
			
			temp["label"]= timeValue
			if( changeInPut>=0 ) 
			{ //long buildup
				temp["y"]= callPutSubstraction
				temp["color"]="#2CA78A" // green color			
				dataPointsArray.push(temp)
			}
			else if( changeInPut < 0 ) 
			{ // long unwinding
				temp["y"]= (- callPutSubstraction )
				temp["color"]="#D4B6A6" // light red color
				//temp["color"]="yellow" // light red color
				dataPointsArray.push(temp)
			}
		}
			
	
	
	
	
		
		
}

	
//console.log( "OIChangeObj", OIChangeObj )
//console.log( "dataPointsArray", dataPointsArray )

return dataPointsArray[0]

}

//await calculate_OI_Data_Change2( "10:16:20", "11:17:51" ) 

async function showIntradayChartWithOIFlowData( dataPointsArray, selectedIndexValue, selectedExpiryValue, chartTimeFrame )
{
/*
  var myData = [
    {
        "open": 17443.8,
        "high": 17443.8,
        "low": 17393.15,
        "close": 17396.3,
        "candleTimeDuration": "09:15-09:18",
        "date": "Fri, 10 Mar 2023 09:15:00 GMT",
        "volume_eur": -11515
    }]
	*/

  var dataPoints1 = [], dataPoints2 = [], dataPoints3 = [];
  //var chart = new CanvasJS.StockChart("IntradayChartWithOIDataFlowContainer",{
var chart = new CanvasJS.StockChart("IntradayChartWithOIDataFlowContainer",{
    exportEnabled: true,
    theme: "dark2",
    title:{
      //text:"StockChart with Tooltip & Crosshair Syncing"
    },
	
	subtitles: [{
			//text: "Subtitle 1"
		  },{
			text: selectedIndexValue +' ('+chartTimeFrame+'m) | Exp: ' +selectedExpiryValue+' | Date: ',
			verticalAlign: "top",
			 horizontalAlign: "right",
			 fontSize: 15,
			dockInsidePlotArea: true
	}],
	axisY: {
      gridThickness: 0,
		},
	 rangeSelector: {
      enabled: false, //Change it to true to enable Range Selector
    },
	

      
    charts: [{
	//	zoomEnabled: true,
      toolTip: {
        shared: true
      },
      axisX: {
	 
        lineThickness: 0,
        tickLength: 0,
        labelFormatter: function(e) {
          return "";
        },
		
        crosshair: {
          enabled: true,
          snapToDataPoint: true,
          labelFormatter: function(e) {
            return ""
          }
        }
      },
      axisY2: {
      //  title: "Litecoin Price",
       // prefix: "",
	   gridThickness: 0,
      },
	 
      legend: {
        verticalAlign: "top",
        horizontalAlign: "left"
      },
	 // height: 400,
	  height: 300,
	  dataPointWidth: 5,
      data: [{
       // name: "Price (in EUR)",
     //   yValueFormatString: "#,###.##",
        axisYType: "secondary",
        type: "candlestick",
       // risingColor: "green",
        //fallingColor: "red",
		 risingColor: "#2CA78A",
        fallingColor: "#cd5652",
        dataPoints : dataPoints1
      }]
    },
	
	{
      //height: 300,
      height: 200,
      toolTip: {
        shared: true
      },
	  /*
      axisX: {
        crosshair: {
          enabled: true,
          snapToDataPoint: true
        }
      },
	  */
	  axisX:{

       //valueFormatString: "YYYY-MM-DD HH:mm K",
       //
    /*
	labelFormatter: function(e) {
      let date = new Date(e.value);
      let content = date.toUTCString();
     //let content = date.toLocaleTimeString(navigator.language, {hour: '2-digit', minute:'2-digit'});
      return content;
    },
	*/
	valueFormatString: "HH:mm tt",
	
          
  crosshair: {
          enabled: true,
          snapToDataPoint: true
        }
      },
      axisY2: {
   //     prefix: "",
      //  title: "LTC/EUR",
	  gridThickness: 0,
      },
      legend: {
        horizontalAlign: "left"
      },
	  dataPointWidth: 5,
      data: [{
        //yValueFormatString: "#,###.##",
		
        axisYType: "secondary",
       // name: "LTC/EUR",
        dataPoints : dataPoints2
      }]
    }],
    navigator: {
	enabled: false, //Change it to true to enable Navigator
     dynamicUpdate: false, // set to true
      slider: {
	   enabled: false,
        //minimum: new Date(2018, 06, 01),
       //maximum: new Date(2018, 08, 01)
      },
	   inputFields: {
	   enabled:false,
	   }
    }
  });
  /*
  $.getJSON("https://canvasjs.com/data/docs/ltceur2018.json", function(data) {
    for(var i = 0; i < data.length; i++){
      dataPoints1.push({x: new Date(data[i].date), y: [Number(data[i].open), Number(data[i].high), Number(data[i].low), Number(data[i].close)], color: data[i].open < data[i].close ? "green" : "red"});;
      dataPoints2.push({x: new Date(data[i].date), y: Number(data[i].volume_eur), color: data[i].open < data[i].close ? "green" : "red"});
      
    }
    stockChart.render();
  });
  */
  
  
  function generateDataPoints(data) {
    for(var i = 0; i < data.length-1; i++){
      //dataPoints1.push({x: new Date(data[i].date), y: [Number(data[i].open), Number(data[i].high), Number(data[i].low), Number(data[i].close)], color: data[i].open < data[i].close ? "green" : "red"});;
      //dataPoints1.push({x: new Date(data[i].date), y: [Number(data[i].open), Number(data[i].high), Number(data[i].low), Number(data[i].close)], color: data[i].open < data[i].close ? "#2CA78A" : "#cd5652"});;
      dataPoints1.push({x: new Date(data[i].date), y: [Number(data[i].open), Number(data[i].high), Number(data[i].low), Number(data[i].close)], color: data[i].open < data[i].close ? "#2CA78A" : "#cd5652"});;
      dataPoints2.push({x: new Date(data[i].date), y: Number(data[i]['OIData']), color: data[i]['OIDataColor'] });
      
    }
	//console.log( dataPoints1,dataPoints2,dataPoints3 )
    chart.render();
  }
  
  
   generateDataPoints( dataPointsArray )



} // showIntradayChartWithOIFlowData ENDS HERE


async function showHeatMapChartWithIntradayChart( selectedIndexValue )
{
	var heatMapSectorSelected 
	
	if( selectedIndexValue=='NIFTY' )
	heatMapSectorSelected = 'NIFTY_50'
else if( selectedIndexValue=='BANKNIFTY' )
	heatMapSectorSelected = 'ALL BANKS'
else if( selectedIndexValue=='FINNIFTY' )
	heatMapSectorSelected = 'NIFTY_FIN_SERVICE'

	document.getElementById("heatMapSectorSelector").value = heatMapSectorSelected
	 showHeatMapChart()

}

async function showHeatMapChartWithIntradayChart2( selectedIndexValue )
{
	await setHighChartsDarkTheme()
	var sectorDataArrayForHeatChart=[{
      id: 'Green',
      //name: 'Green',
      color: "#EC2500"
    }, {
      id: 'Red',
      //name: 'Red',
      color: "#ECE100"
    }]
	
	//var heatMapSectorSelected = document.getElementById("heatMapSectorSelector").value
	var heatMapSectorSelected 
	
	if( selectedIndexValue=='NIFTY' )
	heatMapSectorSelected = 'NIFTY 50'
else if( selectedIndexValue=='BANKNIFTY' )
	heatMapSectorSelected = 'ALL BANKS'
else if( selectedIndexValue=='FINNIFTY' )
	heatMapSectorSelected = 'NIFTY FIN SERVICE'

	
	
	var sectorStockArray;
	if( heatMapSectorSelected=='ALL BANKS' )
	{
		
		for( var sector in mainOIDataObject['sector_stockNames'] )
		{
			if( sector.includes('BANK')==true )
			{
				var sectorStockArray = mainOIDataObject['sector_stockNames'] [sector]['Symbols']
				for( var s=0;s<sectorStockArray.length;s++)
				{
					var Symbol = sectorStockArray [s]
					allBanksStocksObj [Symbol] = 1
				}
				
			}
		}
		
		sectorStockArray = Object.keys(allBanksStocksObj)
	}
	else {
	sectorStockArray = mainOIDataObject['sector_stockNames'] [heatMapSectorSelected]['Symbols']
	}
	for( var s=0;s<sectorStockArray.length;s++)
	{
		var Symbol = sectorStockArray [s]
		//console.log(Symbol)
		if( dataObjectForHeatChart[Symbol] !=undefined )
		{
			sectorDataArrayForHeatChart.push( dataObjectForHeatChart[Symbol] )
		}
	}
	//console.log("sectorDataArrayForHeatChart", sectorDataArrayForHeatChart)
	
	
var H = Highcharts
H.addEvent(H.Legend, 'afterGetAllItems', function(e) {
  e.allItems.splice(2, 6);
});

H.chart('heatMapContainerWithIntradayChart', {
  colorAxis: {
      stops: [
       
	  [0, '#ff0000'],//red
      [0.5, '#fff'], // white
      [1, '#02ff00']//green
	  
    ],
  },
  legend: {
      enabled: false
    },
  series: [{
	animation: false,
	borderWidth: 0.25,
    //borderColor: '#fff',
    borderColor: '#4b4b4c',
    colorAxis: 0,
    legendType: 'point',
    showInLegend: false,
    type: "treemap",
    layoutAlgorithm: 'squarified',
    alternateStartingDirection: true,
    levels: [{
      level: 1,
      layoutAlgorithm: 'sliceAndDice',
      dataLabels: {
        enabled: false,
        align: 'left',
        verticalAlign: 'top',
        style: {
          fontSize: '15px',
          fontWeight: 'bold'
        }
      }
    }],
    data: sectorDataArrayForHeatChart,
	
  dataLabels: {
		enabled: true,
                format: '{point.name} <br> {point.value}',
			 },
			 
			  events: {
                    click: function (event) {
                        //console.log(event.point.name);
						copyHeatMapList( heatMapSectorSelected, event.point.parent )
                    }
                }
  }],
  tooltip: {
            //headerFormat: 'Temperature<br/>',
            pointFormat: '{point.name} <br> pChange: {point.pChange} <br> Rank: {point.value}'
        },
	
  title: {
    text: heatMapSectorSelected +' | '+ dataObjectForHeatChart["selectedTime"] +' | '+ mainOIDataObject['Date'],
	   style: {
                    //color: 'red',
                    fontSize:'15px'
                }
  }
});

}


// OI Flow with OHLC Candlesticks code (ENDS HERE)
</script>


<!-- Floating Buttons Code Starts Here -->
<style>		.float{	position:fixed;	width:25px;	height:50px;	bottom:16%;	right:10px;			border-radius:50px;	text-align:center;	}.vertical-centerFloat {   float: right;  margin: 0;  position: sticky;  top: 50%;  -ms-transform: translateY(-50%);  transform: translateY(-50%);	}  .Floatbtn{ margin-top:1px;} </style>
<div class="float"> 	<button class="Floatbtn" onclick="document.getElementById('commonTimeValues').scrollIntoView();"><b><span style="font-size:20px;">&#8593;</span></b></button><br/>	   	 <button class="Floatbtn" onclick="getFirestoreData('live','')"><b><span style="font-size:20px;">&#8883;</span></b></button>	</div>
<!--<div class="float"> 	<button class="Floatbtn" onclick="document.getElementById('IndicesPerformanceChart').scrollIntoView();"><b><span style="font-size:20px;">&#8593;</span></b></button><br/>	    <button class="Floatbtn" onclick="getFirestoreData('refresh','')"><b><span style="font-size:20px;">&#8635;</span></b></button><br/>		 <button class="Floatbtn" onclick="getFirestoreData('live','')"><b><span style="font-size:20px;">&#8883;</span></b></button><br/>	    <button class="Floatbtn" onclick="document.getElementById(\'indices_performance_time\').scrollIntoView();"><b><span style="font-size:20px;">&#8595;</span></b></button>	<br/>	    <button class="Floatbtn" onclick="document.getElementById(\'EquitySpurtsContainerDiv\').scrollIntoView();"><b><span style="font-size:20px;">&#8595;</span></b></button>	<br/>	    <button class="Floatbtn" onclick="document.getElementById(\'heatMapSectorSelector\').scrollIntoView();"><b><span style="font-size:20px;">&#8595;</span></b></button>	</div> -->
<!-- Floating Buttons Code Ends Here -->


<script>
generateMonthYearFromDate( new Date("April 2023") );
</script>