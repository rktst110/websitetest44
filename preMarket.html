
<!-- Importing Firebase SDK Starts Here-->
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
 <!-- Importing Firebase SDK Ends Here-->
 
 <!-- Importing JS files for charts of CanvaJs & HighCharts Starts Here-->
<script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/heatmap.js"></script>
<script src="https://code.highcharts.com/modules/treemap.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
 <!-- Importing JS files for charts of CanvaJs & HighCharts Ends Here-->
 

  <script src="commonFunctions.js"></script>
  <script src="tableSortingFunctons.js"></script>
 <script src="importFiles.js"></script>
 <script src="firebase.js"></script>
 <script src="firebaseFunctions.js"></script>

 <div id="importedContent"></div>
 
 <title>Pre Market</title>
 
 

<style>
body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background-color: #555;
  color: white; /* Set the text color to white */
}

* {
  box-sizing: border-box;
}
.column1 {
  float: left;
  width: 29.7%;
  padding: 2px;
  height: 500px; 
  margin: 2px 2px;
  border-radius: 5px;
}

.column2 {
  float: left;
  width: 69.7%;
  padding: 2px;
  height: 500px; 
  margin: 2px 2px;
  border-radius: 5px;
}

.row:after {
  content: "";
  display: table;
  clear: both;
}


@media screen and (max-width: 600px) {
  .column1 {
    width: 100%;
  }
  .column2 {
    width: 100%;
  }
}
</style>


 <label>Month Year:</label>
<select id="monthYear" onchange="getFirestoreData()">
</select>

 <label> | Trading Date:</label>
<select id="tradingDate" onchange="setCommonSelectors()">
</select>


 <label> | Common TimeValues:</label>
<select id="commonTimeValues" onchange="saveSelectedValues();fetchDataForAllSegments()">
</select>

&nbsp; | &nbsp;&nbsp;
<button id="dataRefreshButton" onclick="getFirestoreData('refresh','')">Refresh</button>
&nbsp;&nbsp;<button id="dataRefreshButton" onclick="getFirestoreData('live','')">Live</button>

<hr>

 <label> Pre Market TimeValues:</label>
<select id="preMarketTimeValues" onchange="getPreMarketData()">
</select>


<!--Content Start From Here-->
<style>   * {   box-sizing: border-box;   } .spaceBetweenTables { border: 2px solid #4b4d4e;height: 320px;overflow-y: scroll;background-color: #32373a; }  .tableColumnForPreMarket {  float: left;   width: 50%;   padding: 5px;  border: 2px solid #4b4d4e;height: 320px;overflow-y: scroll;background-color: #32373a;  }   .tableRowForPreMarket:after {   content: "";   display: table;   clear: both;   }    .PreOpenMarketClassGainers{   color: #ffffff;   background: #27ae60;   }   .PreOpenMarketClassLoosers{   color: #ffffff;   background: #ea6153;   }  caption {	white-space: nowrap;  text-align: center; color: #9a9c9e; height: px; padding-top: 0rem; padding-bottom: 0rem;	}	div::-webkit-scrollbar {  width: 2px;}				div::-webkit-scrollbar-track {  background: #f1f1f1; }			div::-webkit-scrollbar-thumb {  background: #888; } 		div::-webkit-scrollbar-thumb:hover {  background: #555; }</style>

<span id="AdvancesDeclinesContainer"></span>
<div id="allPreOpenMarketColumnsContainer" class="tableRowForPreMarket"> </div>
<!--Content Ends Here-->


<script>
function fetchDataForAllSegments()
{
setPreMarketSelectorTimeValues();

}
</script>


<!-- Indices Code Starts Here -->
<script>

function setPreMarketSelectorTimeValues( passedValue )
{
	var tradingDate = document.getElementById('tradingDate').value
	var timeValuesArray = firestoreIndexObj[ tradingDate ]['Index']['pre_open_market']['FnO']
	var selectElementRef = document.getElementById("preMarketTimeValues");
	
	handleTimeValues( passedValue, timeValuesArray, selectElementRef, getPreMarketData )
}

async function getPreMarketData( passedValue )
{
	var selectedMonthYear = document.getElementById('monthYear').value
	var selectedTradingDate = document.getElementById('tradingDate').value
	var selectedTimeValue = document.getElementById('preMarketTimeValues').value
	
	var docPath = '/'+selectedMonthYear+'/'+selectedTradingDate+'/pre_open_market/FnO/'+selectedTimeValue+'/'+selectedTimeValue
	var dataObj = await fetchFirebaseDocData( docPath )
	//console.log ( JSON.parse( dataObj['data'] ) )
	
	var collectioPath = '/'+selectedMonthYear+'/'+selectedTradingDate+'/sector_stockNames/'
	var sectorStockNamesObj = await fetchSectorStockNamesCollectionData( collectioPath )
	//console.log("sectorStockNamesObj", sectorStockNamesObj)
	
	show_pre_open_market_Data ( JSON.parse( dataObj['data'] ), sectorStockNamesObj, selectedTradingDate, selectedTimeValue )
	
	
}

async function showIndicesPerformanceChart ( returnedDataObj )
{
	var selectedIndicesTimeValues = document.getElementById('indicesTimeValues').value
	//var selectedValue = document.getElementById("indices_performance_time").value;

	//var indicesPerformanceObject = mainOIDataObject['index_performace'][selectedValue]
	var indicesPerformanceObject = returnedDataObj ['data']
		
	var dataPointsArray=[]
	var dataPointsArrayAdvances=[]
	var dataPointsArrayDeclines=[]
	var dataPointsArrayUnchanged=[]
	var dataPointsArrayPChangeAddition=[]
	
	var tempObj={}
	for (var symbol in indicesPerformanceObject) {
		//if(symbol !='INDIA VIX' && symbol !='NIFTY PSU BANK' && symbol !='NIFTY PVT BANK' && symbol !='NIFTY FINSRV25 50' && symbol !='NIFTY HEALTHCARE' )
		if(symbol !='INDIA VIX' && symbol !='NIFTY FINSRV25 50' && symbol !='NIFTY HEALTHCARE' )
			
		{
		tempObj[symbol]=indicesPerformanceObject[symbol]['percentChange']
		}
	}
	
// tempObj is sorted by this code
//Object.keys(tempObj).sort((a,b) => tempObj[a]-tempObj[b]).forEach((symbol) => { 	// ascending sort
Object.keys(tempObj).sort((a,b) => tempObj[a]-tempObj[b]).forEach((symbol) => {  	//  descending sort
var temp={}
if(symbol !='NIFTY 50' && symbol !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=symbol.replace(/NIFTY /g,'')
}
else{
	temp["label"]=symbol
}
	
		//temp["y"]=tempObj[symbol]; 
		temp["y"]= Math.abs( tempObj[symbol] ); 
		if(tempObj[symbol]<0) 
		{
			temp["color"]="#cd5652"
		}
		else if(tempObj[symbol]>0) 
		{
			temp["color"]="#3a7dd4"
		}
		else if(tempObj[symbol]==0) 
		{
			temp["color"]="black"
		}
		
		dataPointsArray.push(temp)
	});
	
/*
Object.keys(tempObj).sort((a,b) => tempObj[b]-tempObj[a]).forEach((symbol) => {  	//  descending sort
var temp={}
var sectorName = symbol.replace(/_/g,' ')
if(sectorName !='NIFTY 50' && sectorName !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=sectorName.replace(/NIFTY /g,'')
}
else{
	temp["label"]=sectorName
}
	
		temp["y"]=indicesPerformanceObject[symbol][9]; 
		temp["color"]="#089981"
			
		dataPointsArrayAdvances.push(temp)
		//console.log(symbol, preMarketSectorObj[symbol]["advances"])
	});
	
Object.keys(tempObj).sort((a,b) => tempObj[b]-tempObj[a]).forEach((symbol) => {  	//  descending sort
var temp={}
var sectorName = symbol.replace(/_/g,' ')
if(sectorName !='NIFTY 50' && sectorName !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=sectorName.replace(/NIFTY /g,'')
}
else{
	temp["label"]=sectorName
}
	
		temp["y"]=indicesPerformanceObject[symbol][10]; 
		temp["color"]="#cd5652"
		
	
		
		dataPointsArrayDeclines.push(temp)
		
	});	
	
Object.keys(tempObj).sort((a,b) => tempObj[b]-tempObj[a]).forEach((symbol) => {  	//  descending sort
var temp={}
var sectorName = symbol.replace(/_/g,' ')
if(sectorName !='NIFTY 50' && sectorName !='NIFTY BANK')
//if(symbol !='NIFTY BANK')
{
	temp["label"]=sectorName.replace(/NIFTY /g,'')
}
else{
	temp["label"]=sectorName
}
	
		temp["y"]=indicesPerformanceObject[symbol][11]; 
	
		temp["color"]="#cbba4d"
		
		
		dataPointsArrayUnchanged.push(temp)
	});
	
	*/
// this section is for plotting indices chart for simple perchange change of single column bar
var chart = new CanvasJS.Chart("IndicesPerformanceChart", {
	animationEnabled: false,
	theme: "dark2", // "light1", "light2", "dark1", "dark2"
	title: {
		//text: "GDP Growth Rate - 2016"
	},
	subtitles: [{
			//text: "Subtitle 1"
		  },{
			text:  returnedDataObj['timestamp'].split(' ')[0] +' | '+ selectedIndicesTimeValues +' | '+returnedDataObj['timestamp'].split(' ')[1],
			//verticalAlign: "top",

			 //horizontalAlign: "right",
	
			 //fontSize: 15,
			 fontSize: 13,
			//dockInsidePlotArea: true
			dockInsidePlotArea: false
	}],
	
	toolTip: {
			//fontSize: 19,
			fontSize: 15,
	},
	axisY: {
		//title: "Growth Rate (in %)",
		//includeZero: true,
		//suffix: "%",
		gridThickness: 0.1,
		//labelFontSize: 18,
		labelFontSize: 11, // bottom size for change%
	},
	axisX: {
		interval: 1,
		//title: "Countries"
		includeZero: true,
		 //labelFontSize: 17,
		 labelFontSize: 11, // vertical axis size for text
		 //labelFontWeight: "bold",
	},
	dataPointWidth: 9,
	data: [{
		//indexLabel: "{y}",
		//indexLabelFontSize: 18,
		//click: onClick,
		//type: "column",
		type: "bar",
		yValueFormatString: "#,##0.0#\"%\"",
		dataPoints: dataPointsArray
	}]
});


console.log("dataPointsArray",dataPointsArray)
chart.render();
//chart2.render();

} // showIndicesPerformanceChart ENDS HERE

async function show_pre_open_market_Data ( dataObj, sectorStockNamesObj, selectedTradingDate, selectedTimeValue)
{
	 document.getElementById('allPreOpenMarketColumnsContainer').innerHTML = "";

	var selectedValue = selectedTimeValue;

	var preOpenMarketObject = dataObj

	var AdvancesDeclinesUnchanged=preOpenMarketObject['AdvancesDeclinesUnchanged']
	document.getElementById('AdvancesDeclinesContainer').innerHTML =  '<span style="color:#bfffbf">Advances: '+preOpenMarketObject['advances']+'</span><span style="color:#ffb8b8"> &nbsp;&nbsp; Declines: '+preOpenMarketObject['declines']+'</span><span style="color:white"> &nbsp;&nbsp; Unchanged: '+preOpenMarketObject['unchanged']+'</span> &nbsp; | &nbsp; '+selectedTradingDate

	var FnOList={}
	var Nifty50List={}
	
	//var sectorStockNamesObj = sectorStockNamesObj
	if( sectorStockNamesObj !=undefined )
	{
		var FnOSymbols = Object.keys(preOpenMarketObject['data'])
		var Nifty50Symbols = sectorStockNamesObj['NIFTY_50']
		for (var s = 0; s < FnOSymbols.length; s++) {
			var Symbol = FnOSymbols[s]
			var SymbolArray = preOpenMarketObject['data'][Symbol]
			//console.log(Symbol)
			if( SymbolArray!=undefined )
			{
				FnOList[Symbol]= SymbolArray['metadata']['pChange']
			}
			
		}
		
		for (var s = 0; s < Nifty50Symbols.length; s++) {
			var Symbol = Nifty50Symbols[s]
			var SymbolArray = preOpenMarketObject['data'][Symbol]
			if( SymbolArray!=undefined )
			{
				Nifty50List[Symbol]= SymbolArray['metadata']['pChange']
			}
			
		}
	}
	
	
	//Object.fromEntries( Object.entries(FnOList).sort( (a,b) => b[1] - a[1] ) )   // for sorting object ascending
	//Object.fromEntries( Object.entries(FnOList).sort( (a,b) => a[1] - b[1] ) )   // for sorting object descending

	var tablesStr=''

	var ascNiftyTablesStr = '<div class="tableColumnForPreMarket">    <div class="spaceBetweenTables">     <table id="PreMarketAscendingNifty">'
	+'<caption style="caption-side:top">Nifty 50 Gainers (% Change-Wise)</caption>    <thead>       <tr>               <th class="PreOpenMarketClassGainers">Symbol</th>               <th class="PreOpenMarketClassGainers">LTP</th>              <th class="PreOpenMarketClassGainers">Chng%</th>			   <th class="PreOpenMarketClassGainers">TO</th>            </tr>  </thead>'
	+'<tbody>'


	for( var niftyStock=0; niftyStock < Object.keys(Nifty50List).length ; niftyStock++ )
	//for( var niftyStock=0; niftyStock < 15 ; niftyStock++ )
	{
		var AscendingNifty50List = Object.fromEntries( Object.entries(Nifty50List).sort( (a,b) => b[1] - a[1] ) )   // for sorting object ascending
		var DescendingNifty50List = Object.fromEntries( Object.entries(Nifty50List).sort( (a,b) => a[1] - b[1] ) )   // for sorting object descending

		var ascValuesArray=preOpenMarketObject['data'][Object.keys(AscendingNifty50List)[niftyStock]]
		var descValuesArray=preOpenMarketObject['data'][Object.keys(DescendingNifty50List)[niftyStock]]

		ascNiftyTablesStr +='<tr class="item"><td>'
		+Object.keys(AscendingNifty50List)[niftyStock]
		+'</td><td>'
		+ascValuesArray['metadata']['iep'] //lEP
		+'</td><td>'
	 	  +ascValuesArray['metadata']['pChange'] .toFixed(2)
		+'</td><td>'
		+( ascValuesArray['metadata']['totalTurnover']  / 1000 ).toFixed(0)
		+'</td></tr>'

	}
	ascNiftyTablesStr +=' </tbody> </table>    </div>  </div>'

	


	
	var ascFnOTablesStr = '<div class="tableColumnForPreMarket">    <div class="spaceBetweenTables">     <table id="PreMarketAscendingFnO">'
	+'<caption style="caption-side:top">FnO Gainers (% Change-Wise)</caption>     <thead class="PreOpenMarketClassGainers">       <tr>               <th>Symbol</th>               <th>LTP</th>              <th>Chng%</th>			   <th>TO</th>            </tr>   </thead> '
	+'<tbody>'

	for( var FnOStock=0; FnOStock < Object.keys(FnOList).length ; FnOStock++ )
	//for( var FnOStock=0; FnOStock < 15 ; FnOStock++ )
	{
		var AscendingFnOList = Object.fromEntries( Object.entries(FnOList).sort( (a,b) => b[1] - a[1] ) )   // for sorting object ascending
		var DescendingFnOList = Object.fromEntries( Object.entries(FnOList).sort( (a,b) => a[1] - b[1] ) )   // for sorting object descending

		var ascValuesArray=preOpenMarketObject['data'][Object.keys(AscendingFnOList)[FnOStock]]
		var descValuesArray=preOpenMarketObject['data'][Object.keys(DescendingFnOList)[FnOStock]]
	   
		{
		ascFnOTablesStr +='<tr class="item"><td>'
		+Object.keys(AscendingFnOList)[FnOStock]
		+'</td><td>'
		+ascValuesArray['metadata']['iep'] //lEP
		+'</td><td>'
	 	  +ascValuesArray['metadata']['pChange'].toFixed(2)
		+'</td><td>'
		+(ascValuesArray['metadata']['totalTurnover'] / 1000 ).toFixed(0)
		+'</td></tr>'
		}



	}
	ascFnOTablesStr +=' </tbody> </table>    </div>  </div>'

	tablesStr += ascNiftyTablesStr
	tablesStr += ascFnOTablesStr


	 document.getElementById('allPreOpenMarketColumnsContainer').innerHTML = tablesStr;
	 
	  addEventListnerInTables()
	  
}	//	show_pre_open_market_Data() Function ENDS HERE

</script>
<!-- Indices Code Ends Here -->


<script>
// Example usage: generate month and year from April 2023 till now
generateMonthYearFromDate( new Date("April 2023") );
</script>
